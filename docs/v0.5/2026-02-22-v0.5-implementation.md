# v0.5 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** å®Œæˆ v0.5 ç‰ˆæœ¬çš„å¼€å‘ï¼ŒåŒ…æ‹¬ Python åç«¯ uv è¿ç§»ã€æµè§ˆå™¨ç™»å½•æ€ Client-Side Vault æ–¹æ¡ˆã€æ‰§è¡Œæ¨¡å¼åˆ†ç¦»å’Œå‰ç«¯æ ·å¼ä¼˜åŒ–ã€‚

**Architecture:** 
1. Phase 1: å°† Python åç«¯ä» pip + requirements.txt è¿ç§»åˆ° uv + pyproject.toml
2. Phase 2: å®ç° Client-Side Vault æ–¹æ¡ˆï¼Œä½¿ç”¨ IndexedDB å­˜å‚¨å‡­è¯ï¼ŒWebSocket ä¼ è¾“ï¼Œæ”¯æŒäººæœºååŒç™»å½•
3. Phase 3: åœ¨æ‰§è¡Œé¢æ¿å¢åŠ ç®€æ´æ¨¡å¼ï¼Œæ”¯æŒè°ƒè¯•æ¨¡å¼ vs æ—¥å¸¸æ‰§è¡Œæ¨¡å¼åˆ‡æ¢
4. Phase 4: ä¿®å¤ä¾§è¾¹æ é»‘è¾¹ã€æŒ‰é’®äº¤äº’æ•ˆæœã€æœ¯è¯­ç»Ÿä¸€ã€å¼¹çª—æ ·å¼ä¼˜åŒ–

**Tech Stack:** Python 3.12, FastAPI, Playwright, uv, React, TypeScript, localforage, IndexedDB

---

## Phase 1: Python åç«¯æ”¹ç”¨ uv ç®¡ç†

### Task 1: åˆ›å»º pyproject.toml

**Files:**
- Create: `backend/pyproject.toml`

**Step 1: ç¼–å†™ pyproject.toml**

```toml
[project]
name = "schemaflow-backend"
version = "0.5.0"
requires-python = ">=3.12"
dependencies = [
    "fastapi==0.109.0",
    "uvicorn[standard]==0.27.0",
    "websockets==12.0",
    "playwright==1.58.0",
    "openai==1.10.0",
    "httpx==0.27.0",
    "pydantic==2.5.0",
    "aiofiles==23.2.1",
    "python-dotenv==1.0.0",
    "tomli==2.0.1",
]

[tool.uv]
python = "3.12"
```

**Step 2: éªŒè¯æ–‡ä»¶åˆ›å»ºæˆåŠŸ**

```bash
cd backend && ls -la pyproject.toml
```
Expected: æ–‡ä»¶å­˜åœ¨

**Step 3: Commit**

```bash
git add backend/pyproject.toml
git commit -m "feat: add pyproject.toml for uv migration"
```

---

### Task 2: è¿ç§»åˆ° uv ç¯å¢ƒ

**Files:**
- Modify: `backend/.gitignore`

**Step 1: å¤‡ä»½æ—§ç¯å¢ƒå¹¶åˆ›å»º uv ç¯å¢ƒ**

```bash
cd backend
mv .venv .venv.bak.$(date +%Y%m%d)
uv venv --python 3.12
```

**Step 2: å®‰è£…ä¾èµ–**

```bash
uv pip install -e .
```
Expected: å®‰è£…æˆåŠŸï¼Œæ— é”™è¯¯

**Step 3: å®‰è£… Playwright chromium**

```bash
uv run playwright install chromium
```
Expected: chromium å®‰è£…æˆåŠŸ

**Step 4: æ›´æ–° .gitignore**

```bash
echo "uv.lock" >> backend/.gitignore
```

**Step 5: éªŒè¯ç¯å¢ƒ**

```bash
uv run python -c "import fastapi; print(fastapi.__version__)"
```
Expected: è¾“å‡º 0.109.0

**Step 6: éªŒè¯æ¨¡å—å¯¼å…¥**

```bash
uv run python -c "
import sys; sys.path.insert(0,'.')
from config import get_settings
from engine.actions import base, browser, data, control
from engine.executor import WorkflowExecutor
print('All modules imported successfully')
"
```
Expected: è¾“å‡º "All modules imported successfully"

**Step 7: Commit**

```bash
git add backend/.gitignore
git commit -m "chore: migrate to uv package manager"
```

---

### Task 3: åˆ é™¤ requirements.txt

**Files:**
- Delete: `backend/requirements.txt`

**Step 1: ç¡®è®¤è¿ç§»å®Œæˆååˆ é™¤æ—§æ–‡ä»¶**

```bash
cd backend && rm requirements.txt
```

**Step 2: Commit**

```bash
git add -A
git commit -m "chore: remove requirements.txt after uv migration"
```

---

## Phase 2: æµè§ˆå™¨ç™»å½•æ€æ–¹æ¡ˆï¼ˆClient-Side Vaultï¼‰

### Task 4: é‡æ„ BrowserManager ç§»é™¤ CDP ç«¯å£æ‰«æ

**Files:**
- Modify: `backend/engine/browser_manager.py`

**Step 1: é‡å†™ connect æ–¹æ³•**

Replace the entire `connect` method (lines 86-203) with:

```python
async def connect(self, context, headless: bool = True, storage_state=None) -> Tuple[bool, bool]:
    """è¿æ¥æµè§ˆå™¨ã€‚

    å¯åŠ¨ç‹¬ç«‹æµè§ˆå™¨ï¼Œæ”¯æŒæ³¨å…¥ storage_state æ¢å¤ç™»å½•æ€ã€‚

    Args:
        context: æ‰§è¡Œä¸Šä¸‹æ–‡
        headless: æ˜¯å¦æ— å¤´æ¨¡å¼
        storage_state: å¯é€‰ï¼Œå‰ç«¯ä¼ å…¥çš„å‡­è¯ JSONï¼Œç›´æ¥æ³¨å…¥ context

    Returns:
        (is_cdp, reused_page) - å›ºå®šè¿”å› (False, False)ï¼Œä¿ç•™æ¥å£å…¼å®¹
    """
    logger.info(f"[{context.execution_id}] æµè§ˆå™¨è¿æ¥å¼€å§‹")
    await context.log("debug", f"BrowserManager.connect() å¼€å§‹")

    if context.browser is not None:
        is_cdp = getattr(context, '_is_cdp', False)
        await context.log("info", f"æµè§ˆå™¨å·²è¿æ¥ï¼Œå¤ç”¨ç°æœ‰çŠ¶æ€")
        return is_cdp, getattr(context, '_reused_page', False)

    from playwright.async_api import async_playwright
    self.playwright = await async_playwright().start()

    # ä»…å½“ç”¨æˆ·åœ¨ settings ä¸­æ˜ç¡®é…ç½®äº† cdp_url æ—¶æ‰å°è¯• CDP
    cdp_url = None
    try:
        from config import get_settings
        cdp_url = get_settings().get("browser", {}).get("cdp_url_manual")
    except Exception:
        pass

    if cdp_url:
        try:
            await context.log("info", f"å°è¯• CDP è¿æ¥: {cdp_url}")
            context.browser = await self.playwright.chromium.connect_over_cdp(cdp_url)
            self._connected_port = 0  # CDP ä¸ä½¿ç”¨ç«¯å£å·
            
            if storage_state:
                # CDP æ¨¡å¼ä¸‹æ— æ³•ç›´æ¥æ³¨å…¥ storage_state åˆ°æ–° context
                # éœ€è¦åˆ›å»ºæ–° context
                context._context = await context.browser.new_context(storage_state=storage_state)
                context.page = await context._context.new_page()
            else:
                default_context = context.browser.contexts[0]
                context.page = await default_context.new_page()
            
            context._is_cdp = True
            context._reused_page = False
            await context.log("info", f"âœ“ CDP è¿æ¥æˆåŠŸ")
            return True, False
        except Exception as e:
            await context.log("warning", f"CDP è¿æ¥å¤±è´¥: {e}ï¼Œå›é€€åˆ°ç‹¬ç«‹æµè§ˆå™¨")

    # é»˜è®¤è·¯å¾„ï¼šå¯åŠ¨ç‹¬ç«‹æµè§ˆå™¨
    await context.log("info", "å¯åŠ¨ç‹¬ç«‹æµè§ˆå™¨...")
    context.browser = await self.playwright.chromium.launch(headless=headless)

    if storage_state:
        context._context = await context.browser.new_context(storage_state=storage_state)
        await context.log("info", "å·²æ³¨å…¥ç™»å½•å‡­è¯")
    else:
        context._context = await context.browser.new_context()

    context.page = await context._context.new_page()
    context._is_cdp = False
    context._reused_page = False
    
    return False, False
```

**Step 2: æ›´æ–° cleanup æ–¹æ³•æ”¯æŒæ–° context**

Find cleanup method (lines 205-224) and replace with:

```python
async def cleanup(self, context):
    """æ¸…ç†æµè§ˆå™¨èµ„æºã€‚"""
    logger.info(f"[{context.execution_id}] å¼€å§‹æ¸…ç†æµè§ˆå™¨èµ„æº")
    is_cdp = getattr(context, '_is_cdp', False)
    
    if is_cdp:
        # CDP æ¨¡å¼ä¸‹ï¼Œå¦‚æœæœ‰ç‹¬ç«‹åˆ›å»ºçš„ contextï¼Œéœ€è¦å…³é—­
        custom_context = getattr(context, '_context', None)
        if custom_context:
            try:
                await custom_context.close()
                await context.log("debug", "å…³é—­è‡ªå®šä¹‰ context")
            except Exception:
                pass
    
    if self.playwright is not None:
        try:
            await self.playwright.stop()
            logger.info(f"[{context.execution_id}] æµè§ˆå™¨å·²å…³é—­")
        except Exception:
            pass
```

**Step 3: éªŒè¯è¯­æ³•**

```bash
cd backend && uv run python -c "
import py_compile
py_compile.compile('engine/browser_manager.py', doraise=True)
print('Syntax OK')
"
```

**Step 4: Commit**

```bash
git add backend/engine/browser_manager.py
git commit -m "feat: refactor BrowserManager to support storage_state injection"
```

---

### Task 5: åˆ›å»ºç™»å½•æ€æ£€æµ‹æ¨¡å—

**Files:**
- Create: `backend/engine/auth_detector.py`

**Step 1: åˆ›å»º auth_detector.py**

```python
"""ç™»å½•æ€æ£€æµ‹æ¨¡å— - æ£€æµ‹é¡µé¢æ˜¯å¦å¤„äºå·²ç™»å½•çŠ¶æ€ã€‚"""
import logging
from typing import Optional

logger = logging.getLogger(__name__)


async def check_login_status(page, url: str) -> bool:
    """æ£€æµ‹é¡µé¢æ˜¯å¦å¤„äºå·²ç™»å½•çŠ¶æ€ã€‚

    é€šè¿‡ä»¥ä¸‹ä¿¡å·åˆ¤æ–­ï¼š
    1. URL æ˜¯å¦è·³è½¬åˆ°äº† login/signin é¡µé¢
    2. é¡µé¢æ˜¯å¦å­˜åœ¨æ˜æ˜¾çš„ç™»å½•è¡¨å•

    Args:
        page: Playwright page å¯¹è±¡
        url: ç›®æ ‡ URL

    Returns:
        bool: True è¡¨ç¤ºå·²ç™»å½•ï¼ŒFalse è¡¨ç¤ºæœªç™»å½•
    """
    current_url = page.url.lower()
    login_keywords = ["login", "signin", "sign-in", "auth", "passport", "/sign_in", "/log_in"]
    
    if any(kw in current_url for kw in login_keywords):
        logger.debug(f"æ£€æµ‹åˆ°ç™»å½•å…³é”®è¯åœ¨ URL ä¸­: {current_url}")
        return False

    # æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ˜¾çš„ç™»å½•è¡¨å•
    try:
        login_form = await page.query_selector(
            'form[action*="login"], form[action*="signin"], '
            'input[type="password"]:visible, '
            '[data-testid*="login"], [data-testid*="signin"], '
            '.login-form, .signin-form, #login-form, #signin-form'
        )
        if login_form:
            logger.debug("æ£€æµ‹åˆ°ç™»å½•è¡¨å•")
            return False
    except Exception as e:
        logger.warning(f"æ£€æŸ¥ç™»å½•çŠ¶æ€æ—¶å‡ºé”™: {e}")

    return True


async def wait_for_login_completion(page, timeout: int = 300) -> bool:
    """ç­‰å¾…ç”¨æˆ·å®Œæˆç™»å½•ã€‚

    é€šè¿‡æ£€æµ‹é¡µé¢å˜åŒ–æ¥åˆ¤æ–­ç™»å½•æ˜¯å¦å®Œæˆã€‚

    Args:
        page: Playwright page å¯¹è±¡
        timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

    Returns:
        bool: True è¡¨ç¤ºç™»å½•æˆåŠŸï¼ŒFalse è¡¨ç¤ºè¶…æ—¶
    """
    import asyncio
    
    logger.info(f"ç­‰å¾…ç”¨æˆ·ç™»å½•å®Œæˆï¼Œè¶…æ—¶æ—¶é—´: {timeout}ç§’")
    
    start_time = asyncio.get_event_loop().time()
    check_interval = 2  # æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
    
    while (asyncio.get_event_loop().time() - start_time) < timeout:
        # æ£€æŸ¥æ˜¯å¦è¿˜åœ¨ç™»å½•é¡µ
        is_logged_in = await check_login_status(page, page.url)
        if is_logged_in:
            logger.info("æ£€æµ‹åˆ°ç™»å½•å®Œæˆ")
            return True
        
        await asyncio.sleep(check_interval)
    
    logger.warning("ç­‰å¾…ç™»å½•è¶…æ—¶")
    return False
```

**Step 2: éªŒè¯è¯­æ³•**

```bash
cd backend && uv run python -c "
import py_compile
py_compile.compile('engine/auth_detector.py', doraise=True)
print('Syntax OK')
"
```

**Step 3: Commit**

```bash
git add backend/engine/auth_detector.py
git commit -m "feat: add auth detector module for login status checking"
```

---

### Task 6: ä¿®æ”¹ executor.py æ”¯æŒå‡­è¯ä¼ é€’

**Files:**
- Modify: `backend/engine/executor.py`

**Step 1: æ·»åŠ  storage_state å‚æ•°æ”¯æŒ**

Find `execute` method signature (line 75-82) and modify:

```python
async def execute(
    self,
    workflow: Dict[str, Any],
    websocket=None,
    browser=None,
    execution_id: str = None,
    headless: bool = True,
    storage_state: Optional[Dict[str, Any]] = None
) -> ExecutionContext:
```

**Step 2: ä¿®æ”¹ execute æ–¹æ³•ä½“å­˜å‚¨å‚æ•°**

After line 92 (context creation), add:

```python
    context._storage_state = storage_state  # å­˜å‚¨å‰ç«¯ä¼ å…¥çš„å‡­è¯
```

**Step 3: ä¿®æ”¹ _run_workflow ä¼ é€’ storage_state**

Find `_run_workflow` method and line ~132 where `browser_mgr.connect` is called, replace:

```python
await browser_mgr.connect(context, headless)
```

With:

```python
storage_state = getattr(context, '_storage_state', None)
await browser_mgr.connect(context, headless=headless, storage_state=storage_state)
```

**Step 4: åœ¨å·¥ä½œæµæ‰§è¡Œå®Œæˆåæå–å¹¶ä¸‹å‘å‡­è¯**

Find the end of `_run_workflow` method before `_cleanup` call (around line 238). Add after `recorder.sync_to_context(context)` and before `await recorder.save(...)`:

```python
        # æå–å¹¶ä¸‹å‘æœ€æ–°å‡­è¯
        browser_mgr = getattr(context, '_browser_mgr', None)
        if browser_mgr and hasattr(browser_mgr, '_context'):
            try:
                custom_context = getattr(browser_mgr, '_context', None)
                if custom_context:
                    latest_state = await custom_context.storage_state()
                    if context.websocket:
                        await context.websocket.send_json({
                            "type": "storage_state_update",
                            "data": latest_state
                        })
                        logger.info(f"[{context.execution_id}] å·²ä¸‹å‘æœ€æ–°å‡­è¯")
            except Exception as e:
                logger.warning(f"[{context.execution_id}] æå–å‡­è¯å¤±è´¥: {e}")
                # éå…³é”®è·¯å¾„ï¼Œä¸é˜»å¡æ‰§è¡Œ
```

**Step 5: éªŒè¯è¯­æ³•**

```bash
cd backend && uv run python -c "
import py_compile
py_compile.compile('engine/executor.py', doraise=True)
print('Syntax OK')
"
```

**Step 6: Commit**

```bash
git add backend/engine/executor.py
git commit -m "feat: support storage_state injection and extraction in executor"
```

---

### Task 7: ä¿®æ”¹ WebSocket API æ”¯æŒå‡­è¯æ¶ˆæ¯

**Files:**
- Modify: `backend/api/execution.py`

**Step 1: æ‰¾åˆ° WebSocket æ¶ˆæ¯å¤„ç†éƒ¨åˆ†**

The file likely handles WebSocket messages for execution. Find where `start_execution` message is processed.

**Step 2: ä¿®æ”¹ start_execution å¤„ç†é€»è¾‘**

Find the code that processes `start_execution` message type. It likely looks like:

```python
if message.get("type") == "start_execution":
    workflow_id = message.get("workflow_id")
    mode = message.get("mode", "headless")
```

Replace/extend with:

```python
if message.get("type") == "start_execution":
    workflow_id = message.get("workflow_id")
    mode = message.get("mode", "headless")
    storage_state = message.get("injected_storage_state")  # æ–°å¢ï¼šæ¥æ”¶å‰ç«¯å‡­è¯
```

**Step 3: å°† storage_state ä¼ é€’ç»™ executor**

Find where `executor.execute` is called and add the new parameter:

```python
context = await executor.execute(
    workflow=workflow,
    websocket=websocket,
    execution_id=execution_id,
    headless=(mode == "headless"),
    storage_state=storage_state  # æ–°å¢
)
```

**Step 4: æ·»åŠ  login_confirmed æ¶ˆæ¯å¤„ç†**

Find the message handling switch/if-elif block and add:

```python
elif message.get("type") == "login_confirmed":
    # ç”¨æˆ·ç¡®è®¤å·²å®Œæˆç™»å½•ï¼Œé€šçŸ¥æ‰§è¡Œå™¨ç»§ç»­
    execution_id = message.get("execution_id")
    if execution_id and execution_id in executor.active_executions:
        exec_context = executor.active_executions[execution_id]
        # è®¾ç½®ä¸€ä¸ªæ ‡å¿—è¡¨ç¤ºç™»å½•å·²ç¡®è®¤
        exec_context._login_confirmed = True
        await websocket.send_json({
            "type": "login_confirmation_received",
            "execution_id": execution_id
        })
```

**Step 5: éªŒè¯è¯­æ³•**

```bash
cd backend && uv run python -c "
import py_compile
py_compile.compile('api/execution.py', doraise=True)
print('Syntax OK')
"
```

**Step 6: Commit**

```bash
git add backend/api/execution.py
git commit -m "feat: support storage_state and login confirmation in WebSocket API"
```

---

### Task 8: å‰ç«¯å®‰è£… localforage

**Files:**
- Modify: `frontend/package.json`

**Step 1: å®‰è£… localforage**

```bash
cd frontend && npm install localforage
```

**Step 2: éªŒè¯å®‰è£…**

```bash
cd frontend && ls -la node_modules/localforage
```
Expected: ç›®å½•å­˜åœ¨

**Step 3: Commit**

```bash
git add frontend/package*.json
git commit -m "chore: install localforage for IndexedDB storage"
```

---

### Task 9: åˆ›å»ºå‡­è¯å­˜å‚¨æœåŠ¡

**Files:**
- Create: `frontend/src/services/credentialStore.ts`

**Step 1: åˆ›å»º credentialStore.ts**

```typescript
import localforage from 'localforage'

const store = localforage.createInstance({
  name: 'schemaflow',
  storeName: 'credentials'
})

export interface StorageState {
  cookies: Array<{
    name: string
    value: string
    domain: string
    path: string
    expires: number
    httpOnly: boolean
    secure: boolean
    sameSite: string
  }>
  origins: Array<{
    origin: string
    localStorage: Array<{ name: string; value: string }>
  }>
}

// æŒ‰å·¥ä½œæµ ID å­˜å–å‡­è¯
export const credentialStore = {
  async get(workflowId: string): Promise<StorageState | null> {
    return store.getItem<StorageState>(`cred_${workflowId}`)
  },

  async save(workflowId: string, state: StorageState): Promise<void> {
    await store.setItem(`cred_${workflowId}`, state)
  },

  async remove(workflowId: string): Promise<void> {
    await store.removeItem(`cred_${workflowId}`)
  },

  async has(workflowId: string): Promise<boolean> {
    const val = await store.getItem(`cred_${workflowId}`)
    return val !== null
  },

  async clearAll(): Promise<void> {
    await store.clear()
  }
}
```

**Step 2: éªŒè¯ TypeScript ç¼–è¯‘**

```bash
cd frontend && npx tsc --noEmit src/services/credentialStore.ts
```
Expected: æ— é”™è¯¯

**Step 3: Commit**

```bash
git add frontend/src/services/credentialStore.ts
git commit -m "feat: add credential store service using localforage"
```

---

### Task 10: ä¿®æ”¹ useExecution.ts æ”¯æŒå‡­è¯æ³¨å…¥

**Files:**
- Modify: `frontend/src/hooks/useExecution.ts`

**Step 1: å¯¼å…¥ credentialStore**

Add import at the top:

```typescript
import { credentialStore } from '@/services/credentialStore'
```

**Step 2: ä¿®æ”¹ startExecution å‡½æ•°**

Find `startExecution` function (around line 92-102) and modify:

```typescript
const startExecution = useCallback(
  async (workflowId?: string, mode: 'headless' | 'headed' = 'headless') => {
    const wfId = (typeof workflowId === 'string' ? workflowId : null) || workflowIdRef.current
    if (wfId) {
      // ä» IndexedDB è·å–å‡­è¯
      const credentials = await credentialStore.get(wfId)
      send({ 
        type: 'start_execution', 
        workflow_id: wfId, 
        mode,
        injected_storage_state: credentials  // å¯èƒ½ä¸º null
      })
    } else {
      console.error('startExecution: ç¼ºå°‘ workflow_id')
    }
  },
  [send]
)
```

**Step 3: æ·»åŠ  login confirmation æ–¹æ³•**

After `respondUserInput` function, add:

```typescript
const confirmLogin = useCallback(
  (executionId: string) => {
    send({
      type: 'login_confirmed',
      execution_id: executionId
    })
  },
  [send]
)
```

**Step 4: æ›´æ–°è¿”å›å€¼**

Find the return statement (around line 126-137) and add:

```typescript
return {
  connect,
  disconnect,
  startExecution,
  stopExecution,
  respondUserInput,
  confirmLogin,  // æ–°å¢
  reset,
  showPanel,
  setShowPanel,
  executionMode,
  setExecutionMode,
}
```

**Step 5: éªŒè¯ TypeScript ç¼–è¯‘**

```bash
cd frontend && npx tsc --noEmit src/hooks/useExecution.ts
```

**Step 6: Commit**

```bash
git add frontend/src/hooks/useExecution.ts
git commit -m "feat: inject credentials from IndexedDB during execution"
```

---

### Task 11: ä¿®æ”¹ executionStore.ts æ”¯æŒå‡­è¯ç®¡ç†çŠ¶æ€

**Files:**
- Modify: `frontend/src/stores/executionStore.ts`

**Step 1: å¯¼å…¥ credentialStore**

Add import:

```typescript
import { credentialStore } from '@/services/credentialStore'
```

**Step 2: æ‰©å±• ExecutionStoreState æ¥å£**

Find interface `ExecutionStoreState` (around line 11-16) and add:

```typescript
interface ExecutionStoreState {
  isConnected: boolean
  executionState: ExecutionState
  showPanel: boolean
  executionMode: 'headless' | 'headed'
  // æ–°å¢ï¼šç™»å½•æ€ç›¸å…³çŠ¶æ€
  loginRequired: boolean
  loginReason: string | null
  loginUrl: string | null
  currentWorkflowId: string | null
}
```

**Step 3: æ‰©å±• ExecutionStoreActions æ¥å£**

Find interface `ExecutionStoreActions` and add:

```typescript
interface ExecutionStoreActions {
  setConnected: (connected: boolean) => void
  setExecutionId: (id: string | null) => void
  setRunning: (running: boolean) => void
  setNodeStatus: (nodeId: string, status: NodeStatus) => void
  addLog: (log: WSLog) => void
  setScreenshot: (screenshot: string | null) => void
  setUserInputRequest: (request: WSUserInputRequired | null) => void
  addNodeRecord: (record: NodeExecutionRecord) => void
  setShowPanel: (show: boolean) => void
  setExecutionMode: (mode: 'headless' | 'headed') => void
  reset: () => void
  handleMessage: (message: WSMessage) => void
  // æ–°å¢
  setLoginRequired: (required: boolean, reason?: string | null, url?: string | null) => void
  setCurrentWorkflowId: (id: string | null) => void
}
```

**Step 4: æ›´æ–° initial state**

Find `initialExecutionState` and the store creation, update defaults:

```typescript
const initialExecutionState: ExecutionState = {
  executionId: null,
  isRunning: false,
  currentNodeId: null,
  nodeStatuses: {},
  logs: [],
  screenshot: null,
  userInputRequest: null,
  nodeRecords: [],
}

export const useExecutionStore = create<ExecutionStore>((set, get) => ({
  isConnected: false,
  executionState: initialExecutionState,
  showPanel: false,
  executionMode: 'headless',
  // æ–°å¢
  loginRequired: false,
  loginReason: null,
  loginUrl: null,
  currentWorkflowId: null,
  // ... rest of the store
```

**Step 5: æ·»åŠ æ–° actions**

Add new action methods:

```typescript
  setLoginRequired: (required, reason = null, url = null) =>
    set({
      loginRequired: required,
      loginReason: reason,
      loginUrl: url,
    }),

  setCurrentWorkflowId: (id) =>
    set({ currentWorkflowId: id }),
```

**Step 6: ä¿®æ”¹ handleMessage å¤„ç†æ–°æ¶ˆæ¯ç±»å‹**

Find `handleMessage` switch statement and add new cases:

```typescript
case 'storage_state_update':
  // ä¿å­˜åç«¯ä¸‹å‘çš„æœ€æ–°å‡­è¯
  if (message.data && get().currentWorkflowId) {
    credentialStore.save(get().currentWorkflowId!, message.data)
  }
  break

case 'require_manual_login':
  // è®¾ç½®çŠ¶æ€ï¼Œè§¦å‘ UI æ˜¾ç¤ºäººæœºååŒé¢æ¿
  set({
    loginRequired: true,
    loginReason: message.reason,
    loginUrl: message.url
  })
  break

case 'login_confirmation_received':
  // ç™»å½•ç¡®è®¤å·²æ”¶åˆ°ï¼Œå¯ä»¥éšè—ç™»å½•é¢æ¿
  set({ loginRequired: false })
  break
```

**Step 7: éªŒè¯ TypeScript ç¼–è¯‘**

```bash
cd frontend && npx tsc --noEmit src/stores/executionStore.ts
```

**Step 8: Commit**

```bash
git add frontend/src/stores/executionStore.ts
git commit -m "feat: add login state management to execution store"
```

---

### Task 12: åˆ›å»ºå‡­è¯ç®¡ç† UI ç»„ä»¶

**Files:**
- Create: `frontend/src/components/CredentialManager.tsx`

**Step 1: åˆ›å»º CredentialManager ç»„ä»¶**

```typescript
import { useState, useEffect } from 'react'
import { Trash2, CheckCircle, Circle } from 'lucide-react'
import { Button } from '@/components/ui/Button'
import { credentialStore } from '@/services/credentialStore'

interface CredentialManagerProps {
  workflowId: string
  domain?: string
}

export function CredentialManager({ workflowId, domain = 'ç›®æ ‡ç½‘ç«™' }: CredentialManagerProps) {
  const [hasCredential, setHasCredential] = useState(false)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    checkCredential()
  }, [workflowId])

  const checkCredential = async () => {
    const exists = await credentialStore.has(workflowId)
    setHasCredential(exists)
    setLoading(false)
  }

  const handleClear = async () => {
    if (confirm('æ¸…é™¤åä¸‹æ¬¡è¿è¡Œå°†éœ€è¦é‡æ–°ç™»å½•ï¼Œç¡®è®¤æ¸…é™¤å—ï¼Ÿ')) {
      await credentialStore.remove(workflowId)
      setHasCredential(false)
    }
  }

  if (loading) {
    return <div className="text-sm text-gray-500">åŠ è½½ä¸­...</div>
  }

  return (
    <div className="p-4 border border-gray-200 rounded-lg bg-white">
      <h3 className="text-sm font-medium text-gray-900 mb-3 flex items-center gap-2">
        <span>ğŸ”</span> ç™»å½•å‡­è¯
      </h3>

      <div className="flex items-center justify-between py-2">
        <div className="flex items-center gap-2">
          {hasCredential ? (
            <>
              <CheckCircle className="w-4 h-4 text-green-500" />
              <span className="text-sm text-gray-700">{domain} (å·²ä¿å­˜)</span>
            </>
          ) : (
            <>
              <Circle className="w-4 h-4 text-gray-400" />
              <span className="text-sm text-gray-500">{domain} (æ— å‡­è¯)</span>
            </>
          )}
        </div>

        {hasCredential && (
          <Button
            variant="ghost"
            size="sm"
            onClick={handleClear}
            className="text-red-500 hover:text-red-600"
          >
            <Trash2 className="w-4 h-4" />
          </Button>
        )}
      </div>

      <p className="text-xs text-gray-400 mt-2">
        å‡­è¯ä»…ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ä¸­ï¼ŒæœåŠ¡ç«¯ä¸äºˆç•™å­˜
      </p>
    </div>
  )
}
```

**Step 2: éªŒè¯ TypeScript ç¼–è¯‘**

```bash
cd frontend && npx tsc --noEmit src/components/CredentialManager.tsx
```

**Step 3: Commit**

```bash
git add frontend/src/components/CredentialManager.tsx
git commit -m "feat: add CredentialManager UI component"
```

---

### Task 13: åˆ›å»ºäººæœºååŒç™»å½•é¢æ¿ç»„ä»¶

**Files:**
- Create: `frontend/src/components/ExecutionPanel/LoginAssistPanel.tsx`

**Step 1: åˆ›å»ºç›®å½•ç»“æ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰**

```bash
mkdir -p frontend/src/components/ExecutionPanel
```

**Step 2: åˆ›å»º LoginAssistPanel ç»„ä»¶**

```typescript
import { Button } from '@/components/ui/Button'
import { useExecutionStore } from '@/stores/executionStore'
import { useExecution } from '@/hooks/useExecution'

interface LoginAssistPanelProps {
  screenshot?: string | null
}

export function LoginAssistPanel({ screenshot }: LoginAssistPanelProps) {
  const { loginRequired, loginReason, loginUrl, executionState } = useExecutionStore()
  const { confirmLogin, stopExecution } = useExecution()

  if (!loginRequired) {
    return null
  }

  const getReasonText = () => {
    switch (loginReason) {
      case 'TOKEN_EXPIRED':
        return 'æ‚¨çš„ç™»å½•å‡­è¯å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•'
      case 'NO_CREDENTIALS':
        return 'è¯¥ç½‘ç«™éœ€è¦ç™»å½•æ‰èƒ½ç»§ç»­'
      default:
        return 'éœ€è¦ç™»å½•æ‰èƒ½ç»§ç»­æ‰§è¡Œ'
    }
  }

  const handleConfirmLogin = () => {
    if (executionState.executionId) {
      confirmLogin(executionState.executionId)
    }
  }

  return (
    <div className="absolute inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 overflow-hidden">
        <div className="p-4 border-b border-gray-200">
          <h3 className="text-lg font-medium text-gray-900 flex items-center gap-2">
            <span>âš ï¸</span> éœ€è¦æ‰‹åŠ¨ç™»å½•
          </h3>
          <p className="text-sm text-gray-600 mt-1">
            {getReasonText()}
          </p>
          {loginUrl && (
            <p className="text-xs text-gray-500 mt-1">
              ç›®æ ‡: {loginUrl}
            </p>
          )}
        </div>

        <div className="p-4 bg-gray-50">
          <p className="text-sm text-gray-600 mb-3">
            è¯·åœ¨ä¸‹æ–¹æˆªå›¾ä¸­å®Œæˆç™»å½•æ“ä½œã€‚ç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹ç™»å½•å®Œæˆå¹¶ç»§ç»­æ‰§è¡Œã€‚
          </p>

          {screenshot ? (
            <div className="border border-gray-300 rounded-lg overflow-hidden">
              <img
                src={`data:image/png;base64,${screenshot}`}
                alt="æµè§ˆå™¨å®æ—¶ç”»é¢"
                className="w-full"
              />
            </div>
          ) : (
            <div className="h-64 bg-gray-200 rounded-lg flex items-center justify-center">
              <span className="text-gray-400">ç­‰å¾…æˆªå›¾...</span>
            </div>
          )}
        </div>

        <div className="p-4 border-t border-gray-200 flex justify-end gap-3">
          <Button variant="secondary" onClick={stopExecution}>
            å–æ¶ˆæ‰§è¡Œ
          </Button>
          <Button variant="secondary">
            è·³è¿‡
          </Button>
          <Button onClick={handleConfirmLogin}>
            å·²å®Œæˆç™»å½•
          </Button>
        </div>
      </div>
    </div>
  )
}
```

**Step 3: éªŒè¯ TypeScript ç¼–è¯‘**

```bash
cd frontend && npx tsc --noEmit src/components/ExecutionPanel/LoginAssistPanel.tsx
```

**Step 4: Commit**

```bash
git add frontend/src/components/ExecutionPanel/LoginAssistPanel.tsx
git commit -m "feat: add LoginAssistPanel for manual login assistance"
```

---

## Phase 3: æ‰§è¡Œæ¨¡å¼åˆ†ç¦»

### Task 14: ä¿®æ”¹ executionStore æ”¯æŒ viewMode

**Files:**
- Modify: `frontend/src/stores/executionStore.ts`

**Step 1: æ‰©å±•çŠ¶æ€ç±»å‹**

Add to `ExecutionStoreState` interface:

```typescript
interface ExecutionStoreState {
  isConnected: boolean
  executionState: ExecutionState
  showPanel: boolean
  executionMode: 'headless' | 'headed'
  loginRequired: boolean
  loginReason: string | null
  loginUrl: string | null
  currentWorkflowId: string | null
  // æ–°å¢
  viewMode: 'debug' | 'compact'
}
```

**Step 2: æ·»åŠ  action**

Add to `ExecutionStoreActions`:

```typescript
  setViewMode: (mode: 'debug' | 'compact') => void
```

**Step 3: æ›´æ–°åˆå§‹å€¼å’Œ store**

```typescript
export const useExecutionStore = create<ExecutionStore>((set, get) => ({
  isConnected: false,
  executionState: initialExecutionState,
  showPanel: false,
  executionMode: 'headless',
  loginRequired: false,
  loginReason: null,
  loginUrl: null,
  currentWorkflowId: null,
  viewMode: 'debug',  // é»˜è®¤è°ƒè¯•æ¨¡å¼
  // ...
```

**Step 4: æ·»åŠ  action å®ç°**

```typescript
  setViewMode: (mode) => set({ viewMode: mode }),
```

**Step 5: Commit**

```bash
git add frontend/src/stores/executionStore.ts
git commit -m "feat: add viewMode state for debug/compact mode switching"
```

---

### Task 15: ä¿®æ”¹ ExecutionPanel æ”¯æŒç®€æ´æ¨¡å¼

**Files:**
- Modify: `frontend/src/components/ExecutionPanel/index.tsx`

**Step 1: è¯»å– viewMode çŠ¶æ€**

Add import and usage:

```typescript
import { useExecutionStore } from '@/stores/executionStore'

// In component
const { viewMode, setViewMode } = useExecutionStore()
```

**Step 2: æ·»åŠ æ¨¡å¼åˆ‡æ¢ UI**

Add mode toggle buttons in the panel header:

```typescript
<div className="flex items-center gap-2">
  <button
    onClick={() => setViewMode('debug')}
    className={`px-3 py-1 text-sm rounded ${
      viewMode === 'debug' 
        ? 'bg-blue-500 text-white' 
        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
    }`}
  >
    è°ƒè¯•
  </button>
  <button
    onClick={() => setViewMode('compact')}
    className={`px-3 py-1 text-sm rounded ${
      viewMode === 'compact' 
        ? 'bg-blue-500 text-white' 
        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
    }`}
  >
    ç®€æ´
  </button>
</div>
```

**Step 3: æ ¹æ® viewMode æ¸²æŸ“ä¸åŒå¸ƒå±€**

Wrap the panel content with conditional rendering:

```typescript
{viewMode === 'debug' ? (
  // ç°æœ‰çš„è°ƒè¯•æ¨¡å¼å¸ƒå±€
  <DebugModeLayout />
) : (
  // æ–°å¢çš„ç®€æ´æ¨¡å¼å¸ƒå±€
  <CompactModeLayout />
)}
```

**Step 4: åˆ›å»ºç®€æ´æ¨¡å¼å¸ƒå±€ç»„ä»¶**

Create inline or separate component:

```typescript
const CompactModeLayout = () => (
  <div className="flex flex-col h-full">
    {/* èŠ‚ç‚¹åˆ—è¡¨ */}
    <div className="flex-1 overflow-y-auto p-4">
      <h3 className="text-sm font-medium mb-2">èŠ‚ç‚¹åˆ—è¡¨</h3>
      <NodeList />
    </div>
    
    {/* å®æ—¶æˆªå›¾ */}
    <div className="h-1/3 border-t border-gray-200">
      <h3 className="text-sm font-medium p-2">å®æ—¶æˆªå›¾</h3>
      <ScreenshotDisplay />
    </div>
    
    {/* æ—¥å¿— */}
    <div className="h-1/4 border-t border-gray-200">
      <h3 className="text-sm font-medium p-2">æ—¥å¿—</h3>
      <LogDisplay />
    </div>
  </div>
)
```

**Step 5: Commit**

```bash
git add frontend/src/components/ExecutionPanel/index.tsx
git commit -m "feat: add compact mode to ExecutionPanel"
```

---

### Task 16: ä¿®æ”¹ Header å¢åŠ æ‰§è¡Œæ¨¡å¼åˆ‡æ¢

**Files:**
- Modify: `frontend/src/components/Header.tsx`

**Step 1: å¯¼å…¥ viewMode**

```typescript
import { useExecutionStore } from '@/stores/executionStore'

const { viewMode, setViewMode } = useExecutionStore()
```

**Step 2: åœ¨æ‰§è¡ŒæŒ‰é’®æ—æ·»åŠ æ¨¡å¼é€‰æ‹©**

Add mode toggle near the execute button:

```typescript
<div className="flex items-center gap-2">
  <span className="text-sm text-gray-500">æ‰§è¡Œæ¨¡å¼:</span>
  <select
    value={viewMode}
    onChange={(e) => setViewMode(e.target.value as 'debug' | 'compact')}
    className="text-sm border border-gray-300 rounded px-2 py-1"
  >
    <option value="debug">è°ƒè¯•æ¨¡å¼</option>
    <option value="compact">ç®€æ´æ¨¡å¼</option>
  </select>
</div>
```

**Step 3: Commit**

```bash
git add frontend/src/components/Header.tsx
git commit -m "feat: add execution mode selector to Header"
```

---

### Task 17: ä¿®æ”¹ WorkflowList å¢åŠ å¿«æ·æ‰§è¡ŒæŒ‰é’®

**Files:**
- Modify: `frontend/src/components/WorkflowList/index.tsx`

**Step 1: å¯¼å…¥å¿…è¦çš„ hooks**

```typescript
import { Play } from 'lucide-react'
import { useExecutionStore } from '@/stores/executionStore'
```

**Step 2: æ·»åŠ å¿«æ·æ‰§è¡Œå¤„ç†å‡½æ•°**

Add to component:

```typescript
const { setViewMode, setShowPanel } = useExecutionStore()
const { startExecution } = useExecution()

const handleQuickExecute = (workflowId: string) => {
  // é€‰ä¸­å·¥ä½œæµ
  onSelectWorkflow(workflowId)
  // åˆ‡æ¢åˆ°ç®€æ´æ¨¡å¼
  setViewMode('compact')
  // æ˜¾ç¤ºæ‰§è¡Œé¢æ¿
  setShowPanel(true)
  // å¼€å§‹æ‰§è¡Œ
  startExecution(workflowId, 'headless')
}
```

**Step 3: åœ¨åˆ—è¡¨é¡¹ä¸­æ·»åŠ æ‰§è¡ŒæŒ‰é’®**

Find the workflow list item rendering and add:

```typescript
<div className="group flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
  <div onClick={() => onSelectWorkflow(workflow.id)}>
    {/* å·¥ä½œæµåç§°ç­‰å†…å®¹ */}
  </div>
  
  <button
    onClick={(e) => {
      e.stopPropagation()
      handleQuickExecute(workflow.id)
    }}
    className="opacity-0 group-hover:opacity-100 p-2 text-gray-500 hover:text-blue-500 hover:bg-blue-50 rounded transition-all"
    title="å¿«é€Ÿæ‰§è¡Œ"
  >
    <Play size={14} />
  </button>
</div>
```

**Step 4: Commit**

```bash
git add frontend/src/components/WorkflowList/index.tsx
git commit -m "feat: add quick execute button to WorkflowList"
```

---

## Phase 4: å‰ç«¯æ ·å¼ä¼˜åŒ–

### Task 18: ä¿®å¤ä¾§è¾¹æ é»‘è¾¹

**Files:**
- Modify: `frontend/src/components/FlowEditor/panels/Toolbar.tsx`
- Modify: `frontend/src/components/FlowEditor/panels/NodePanel.tsx`
- Modify: `frontend/src/components/ExecutionPanel/index.tsx`

**Step 1: æœç´¢å¹¶æ›¿æ¢é»‘è¾¹æ ·å¼**

Search for and replace in each file:

```bash
cd frontend
grep -r "border-black" src/components/FlowEditor/panels/
grep -r "border-gray-800" src/components/FlowEditor/panels/
grep -r "border-gray-700" src/components/
```

**Step 2: æ›¿æ¢ä¸ºæµ…è‰²è¾¹æ¡†**

Replace all instances:
- `border-black` â†’ `border-gray-200`
- `border-gray-800` â†’ `border-gray-200`
- `border-gray-700` â†’ `border-gray-300`

Or replace with shadow:
- `border-black` â†’ `shadow-sm` (remove border, add shadow)

**Step 3: éªŒè¯ä¿®æ”¹**

```bash
cd frontend && npm run lint
```

**Step 4: Commit**

```bash
git add -A
git commit -m "style: fix sidebar dark borders"
```

---

### Task 19: æ·»åŠ æŒ‰é’®äº¤äº’æ•ˆæœ

**Files:**
- Modify: `frontend/src/components/FlowEditor/index.tsx`
- Modify: `frontend/src/components/WorkflowList/index.tsx`
- Modify: `frontend/src/components/Header.tsx`

**Step 1: æ›¿æ¢åŸç”Ÿ button ä¸º Button ç»„ä»¶**

Find native `<button` tags and replace with `<Button` component where appropriate.

In `FlowEditor/index.tsx` around line 304-308:

```typescript
// Before
<button onClick={handleSave}>ä¿å­˜</button>

// After
<Button onClick={handleSave} variant="primary">ä¿å­˜</Button>
```

**Step 2: ä¸ºå¿…é¡»ä½¿ç”¨åŸç”Ÿ button çš„åœ°æ–¹æ·»åŠ äº¤äº’ç±»**

For buttons that must remain native, add:

```typescript
<button
  className="
    transition-all duration-150
    hover:bg-gray-100
    active:scale-[0.97]
    focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-1
  "
>
```

**Step 3: éªŒè¯æ‰€æœ‰æŒ‰é’®éƒ½æœ‰äº¤äº’æ•ˆæœ**

```bash
cd frontend
grep -r "<button" src/components/ --include="*.tsx" | grep -v "Button"
```
Ensure all remaining native buttons have transition/hover classes.

**Step 4: Commit**

```bash
git add -A
git commit -m "style: add button interaction effects"
```

---

### Task 20: ç»Ÿä¸€æœ¯è¯­ï¼ˆè¿è¡Œ â†’ æ‰§è¡Œï¼‰

**Files:**
- Modify: All files with Chinese text

**Step 1: æœç´¢æ‰€æœ‰åŒ…å«"è¿è¡Œ"çš„æ–‡ä»¶**

```bash
cd frontend
grep -r "è¿è¡Œ" src/ --include="*.tsx" --include="*.ts"
```

**Step 2: æ›¿æ¢æœ¯è¯­**

Replace:
- `è¿è¡Œ` â†’ `æ‰§è¡Œ` (when referring to workflow execution)
- `è¿è¡Œä¸­` â†’ `æ‰§è¡Œä¸­`
- `å†æ¬¡è¿è¡Œ` â†’ `é‡æ–°æ‰§è¡Œ`
- `åœæ­¢è¿è¡Œ` â†’ `åœæ­¢æ‰§è¡Œ`

Keep `è¿è¡Œ` only when it means "operation/running state" not "execute action".

**Step 3: Commit**

```bash
git add -A
git commit -m "style: unify terminology - replace 'è¿è¡Œ' with 'æ‰§è¡Œ'"
```

---

### Task 21: ä¼˜åŒ–åˆ›å»ºå·¥ä½œæµå¼¹çª—æ ·å¼

**Files:**
- Modify: `frontend/src/components/WorkflowList/index.tsx`

**Step 1: ç¡®è®¤ä½¿ç”¨ Modal ç»„ä»¶**

Ensure the create workflow dialog uses the existing `Modal` component.

**Step 2: ä¼˜åŒ–è¡¨å•å¸ƒå±€**

Update the create workflow form to use:

```typescript
import { Modal } from '@/components/ui/Modal'
import { Input } from '@/components/ui/Input'
import { Button } from '@/components/ui/Button'

// In render
<Modal
  isOpen={isCreateModalOpen}
  onClose={() => setIsCreateModalOpen(false)}
  title="åˆ›å»ºå·¥ä½œæµ"
  size="md"
>
  <div className="p-6 space-y-4">
    <FormField label="å·¥ä½œæµåç§°" required>
      <Input
        value={newWorkflowName}
        onChange={(e) => setNewWorkflowName(e.target.value)}
        placeholder="è¾“å…¥å·¥ä½œæµåç§°"
      />
    </FormField>
    
    <FormField label="æè¿°">
      <Textarea
        value={newWorkflowDesc}
        onChange={(e) => setNewWorkflowDesc(e.target.value)}
        placeholder="è¾“å…¥å·¥ä½œæµæè¿°ï¼ˆå¯é€‰ï¼‰"
        rows={3}
      />
    </FormField>
    
    <div className="flex justify-end gap-3 pt-4">
      <Button
        variant="secondary"
        onClick={() => setIsCreateModalOpen(false)}
      >
        å–æ¶ˆ
      </Button>
      <Button
        variant="primary"
        onClick={handleCreateWorkflow}
        disabled={!newWorkflowName.trim()}
      >
        åˆ›å»º
      </Button>
    </div>
  </div>
</Modal>
```

**Step 3: æ·»åŠ åŠ¨ç”»æ•ˆæœ**

If `Modal` component doesn't have animation, add:

```typescript
<Modal
  // ... existing props
  className="transition-all duration-200"
>
```

**Step 4: Commit**

```bash
git add frontend/src/components/WorkflowList/index.tsx
git commit -m "style: improve create workflow modal styling"
```

---

## éªŒè¯æ¸…å•

### Phase 1 éªŒè¯

```bash
# uv ç¯å¢ƒéªŒè¯
cd backend && uv run python -c "
import sys; sys.path.insert(0,'.')
from config import get_settings
from engine.actions import base, browser, data, control
from engine.executor import WorkflowExecutor
from api.websocket import manager
from repository import get_execution_repo
print('æ‰€æœ‰æ¨¡å—å¯¼å…¥æˆåŠŸ')
"

# åç«¯å¯åŠ¨éªŒè¯
cd backend && uv run python main.py
```

### Phase 2 éªŒè¯

```bash
# åç«¯è¯­æ³•æ£€æŸ¥
cd backend && uv run python -c "
import py_compile, glob
for f in glob.glob('**/*.py', recursive=True):
    if '.venv' in f: continue
    py_compile.compile(f, doraise=True)
    print(f'OK: {f}')
"

# å‰ç«¯ç±»å‹æ£€æŸ¥
cd frontend && npx tsc --noEmit

# å‰ç«¯ lint
cd frontend && npm run lint
```

**åŠŸèƒ½éªŒè¯ï¼š**
1. ä¸ä¼ å‡­è¯ â†’ åº”ä½¿ç”¨ headless æµè§ˆå™¨æ­£å¸¸æ‰§è¡Œ
2. æ‰‹åŠ¨ç™»å½•å â†’ å‰ç«¯ IndexedDB ä¸­åº”ä¿å­˜å‡­è¯
3. å†æ¬¡æ‰§è¡ŒåŒå·¥ä½œæµ â†’ åº”è‡ªåŠ¨æ³¨å…¥å‡­è¯ï¼Œè·³è¿‡ç™»å½•
4. æ¸…é™¤å‡­è¯å â†’ åº”é‡æ–°è¦æ±‚ç™»å½•
5. ä½¿ç”¨è¿‡æœŸå‡­è¯ â†’ åº”æ£€æµ‹åˆ°å¹¶è§¦å‘äººæœºååŒç™»å½•

### Phase 3 éªŒè¯
- ç®€æ´æ¨¡å¼ä¸‹èƒ½çœ‹åˆ°èŠ‚ç‚¹åˆ—è¡¨ã€æˆªå›¾ã€æ—¥å¿—
- è°ƒè¯•æ¨¡å¼ä¸‹ä¿æŒåŸæœ‰ç”»å¸ƒç¼–è¾‘åŠŸèƒ½
- å¿«æ·æ‰§è¡Œèƒ½æ­£ç¡®é€‰ä¸­å·¥ä½œæµå¹¶å¼€å§‹æ‰§è¡Œ

### Phase 4 éªŒè¯
- æ‰€æœ‰ä¾§è¾¹æ æ— é»‘è¾¹
- æ‰€æœ‰æŒ‰é’®æœ‰ hover/active åé¦ˆ
- å…¨å±€æ— "è¿è¡Œ"/"æ‰§è¡Œ"æœ¯è¯­æ··ç”¨
- åˆ›å»ºå·¥ä½œæµå¼¹çª—æ ·å¼ç»Ÿä¸€

### æœ€ç»ˆéªŒè¯

```bash
# åç«¯å…¨é‡è¯­æ³•æ£€æŸ¥
cd backend && uv run python -c "
import py_compile, glob
for f in glob.glob('**/*.py', recursive=True):
    if '.venv' in f: continue
    py_compile.compile(f, doraise=True)
    print(f'OK: {f}')
"

# å‰ç«¯å®Œæ•´æ„å»º
cd frontend && npm run build

# é›†æˆæµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
cd backend && uv run python test_backend.py
```

---

## æ€»ç»“

æœ¬è®¡åˆ’åŒ…å« **21 ä¸ªä»»åŠ¡**ï¼Œåˆ†ä¸º 4 ä¸ª Phaseï¼š

1. **Phase 1** (Tasks 1-3): Python åç«¯ uv è¿ç§»
2. **Phase 2** (Tasks 4-13): Client-Side Vault ç™»å½•æ€æ–¹æ¡ˆ
3. **Phase 3** (Tasks 14-17): æ‰§è¡Œæ¨¡å¼åˆ†ç¦»
4. **Phase 4** (Tasks 18-21): å‰ç«¯æ ·å¼ä¼˜åŒ–

æ¯ä¸ªä»»åŠ¡éƒ½æœ‰æ˜ç¡®çš„æ­¥éª¤ã€ä»£ç ç¤ºä¾‹å’ŒéªŒè¯æ–¹æ³•ã€‚å»ºè®®æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ¯å®Œæˆä¸€ä¸ª Phase è¿›è¡Œä¸€æ¬¡å…¨é¢éªŒè¯ã€‚

**å»ºè®®çš„å¼€å‘é¡ºåºï¼š**
- Phase 1 â†’ Phase 2ï¼ˆåç«¯éƒ¨åˆ†ï¼‰â†’ Phase 2ï¼ˆå‰ç«¯éƒ¨åˆ†ï¼‰â†’ Phase 3 â†’ Phase 4
- Phase 4 å¯ä»¥ä¸å…¶ä»– Phase å¹¶è¡Œå¼€å‘

**æ³¨æ„äº‹é¡¹ï¼š**
1. æ¯ä¸ª Task å®Œæˆåå¿…é¡» commit
2. æ¯ä¸ª Phase å®Œæˆåå¿…é¡»è¿è¡ŒéªŒè¯å‘½ä»¤
3. å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå…ˆæ£€æŸ¥è¯­æ³•é”™è¯¯ï¼Œå†æ£€æŸ¥é€»è¾‘
4. ä¿æŒä»£ç é£æ ¼ä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

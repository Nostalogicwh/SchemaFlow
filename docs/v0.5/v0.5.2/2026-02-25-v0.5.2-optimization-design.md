# v0.5.2 优化设计文档

> 日期：2026-02-25
> 状态：已确认

## 概述

完成 v0.5.2 剩余的优化项：
1. 实时截图与截图节点支持放大查看
2. API 帮助页面增强（Skill 模板 + 代码片段）
3. 后端 API 测试用例

---

## 设计 1：ImageViewer 组件

### 文件位置

```
frontend/src/components/ui/ImageViewer.tsx
```

### Props 接口

```typescript
interface ImageViewerProps {
  src: string           // 图片地址（base64 或 URL）
  isOpen: boolean       // 是否打开
  onClose: () => void   // 关闭回调
  downloadable?: boolean // 是否显示下载按钮
  filename?: string      // 下载时的文件名
}
```

### 功能特性

| 功能 | 实现方式 |
|------|----------|
| 全屏遮罩 | `fixed inset-0 bg-black/90 z-50` |
| 滚轮缩放 | 监听 `wheel` 事件，调整 `scale`（0.5x - 5x） |
| 拖拽移动 | `mousedown` → `mousemove` → `mouseup`，调整 `translate` |
| 双击重置 | 双击恢复 scale=1, translate=(0,0) |
| 关闭方式 | 点击背景 / 按 ESC / 点击关闭按钮 |
| 下载 | `<a download>` 触发下载 |

### 使用位置

1. **ExecutionPanel** - 实时截图区域添加点击事件
2. **NodePanel** - 截图节点预览区域添加点击事件

---

## 设计 2：API 帮助页面增强

### Skill 标签页内容

提供两种下载格式：

**1. Skill 文件（.skill 格式）**

```
schemaflow-trigger/
├── SKILL.md
└── scripts/
    └── trigger.py
```

**SKILL.md**：
- YAML frontmatter: name, description（包含触发场景）
- Markdown: 配置说明、使用方法、示例代码

**scripts/trigger.py**：
- `trigger_workflow(workflow_id, variables, headless)` - 触发执行
- `get_result(execution_id)` - 获取结果

**2. TypeScript 代码片段**

单独提供，方便前端项目直接使用。

### UI 交互

- 标签页：[触发端点] [cURL] [JavaScript] [Skill]
- Skill 标签页底部：[复制代码] [下载 Skill 包]

### 复制/下载功能

| 按钮 | 功能 |
|------|------|
| 复制 | `navigator.clipboard.writeText()` + Toast 提示 |
| 下载 | `Blob` + `URL.createObjectURL()` 触发下载 |

---

## 设计 3：后端 API 测试

### 文件位置

```
backend/tests/test_trigger_api.py
```

### 测试用例

| 测试场景 | 说明 |
|----------|------|
| `test_trigger_workflow_success` | 有效 API Key 触发工作流 |
| `test_trigger_workflow_invalid_key` | 无效 API Key 返回 401 |
| `test_trigger_workflow_missing_key` | 缺少 API Key 返回 401 |
| `test_get_execution_result` | 获取执行结果 |
| `test_get_result_not_found` | 执行 ID 不存在 |
| `test_api_key_status` | 检查 API Key 状态 |

### 验证命令

```bash
cd backend
.venv/bin/python -m pytest tests/test_trigger_api.py -v
```

---

## 涉及文件汇总

| 类型 | 文件路径 |
|------|----------|
| 新建 | `frontend/src/components/ui/ImageViewer.tsx` |
| 修改 | `frontend/src/components/ExecutionPanel/index.tsx` |
| 修改 | `frontend/src/components/FlowEditor/panels/NodePanel.tsx` |
| 修改 | `frontend/src/components/Header.tsx` |
| 新建 | `backend/tests/test_trigger_api.py` |

# v0.4.2 重构设计文档

> **设计日期：** 2026-02-22
> **版本目标：** 优化和重构

## 概述

v0.4.2 版本聚焦三个方向的重构优化：
1. 前端状态管理优化（保持分离，统一模式）
2. 前后端统一错误处理
3. UI 组件交互效果统一优化

---

## 1. Store 优化（保持分离）

### 当前问题

- 三个 Store（workflowStore、executionStore、uiStore）职责清晰，无需合并
- 但缺少公共模式，代码有重复
- action 命名风格不完全一致

### 改进方案

```
stores/
├── base.ts          # 公共模式：createSelector、asyncAction 包装器
├── workflowStore.ts # 保持，统一 action 命名
├── executionStore.ts# 保持，统一 action 命名
├── uiStore.ts       # 保持，统一 action 命名
└── index.ts
```

### base.ts 公共模式

```typescript
// 异步 Action 包装器，自动处理 loading/error 状态
export function createAsyncAction<T, Args extends unknown[]>(
  fn: (...args: Args) => Promise<T>,
  options?: {
    onStart?: () => void
    onSuccess?: (result: T) => void
    onError?: (error: Error) => void
  }
) {
  return async (...args: Args): Promise<T | null> => {
    try {
      options?.onStart?.()
      const result = await fn(...args)
      options?.onSuccess?.(result)
      return result
    } catch (error) {
      options?.onError?.(error as Error)
      return null
    }
  }
}

// 状态选择器优化
export function createSelector<T, S>(store: T, selector: (state: T) => S): S {
  return selector(store)
}
```

### 命名规范

| 操作类型 | 命名前缀 | 示例 |
|---------|---------|------|
| 设置单个值 | `set*` | `setConnected`, `setRunning` |
| 更新部分值 | `update*` | `updateWorkflow` |
| 重置状态 | `reset` | `reset` |
| 异步操作 | `*Async` 或动词 | `fetchWorkflow`, `saveWorkflow` |

---

## 2. 错误处理统一

### 前端：useErrorHandler Hook

```typescript
// hooks/useErrorHandler.ts
import { toast } from '@/stores/uiStore'

export function useErrorHandler() {
  return (error: unknown, fallbackMessage = '操作失败') => {
    const message = error instanceof Error ? error.message : fallbackMessage
    console.error('[Error]', error)
    toast.error(message)
  }
}

// 使用示例
const handleError = useErrorHandler()
try {
  await workflowApi.create(...)
} catch (e) {
  handleError(e, '创建工作流失败')
}
```

### 后端：统一异常体系

```python
# api/exceptions.py
class APIException(Exception):
    """API 统一异常基类"""
    def __init__(
        self, 
        message: str, 
        code: str = "UNKNOWN_ERROR", 
        status_code: int = 400
    ):
        self.message = message
        self.code = code
        self.status_code = status_code

class NotFoundError(APIException):
    def __init__(self, resource: str, resource_id: str):
        super().__init__(
            message=f"{resource} 不存在: {resource_id}",
            code="NOT_FOUND",
            status_code=404
        )

class ValidationError(APIException):
    def __init__(self, message: str):
        super().__init__(
            message=message,
            code="VALIDATION_ERROR",
            status_code=422
        )
```

### 后端：统一响应格式

```python
# api/response.py
from typing import Any, Optional
from pydantic import BaseModel

class APIResponse(BaseModel):
    success: bool
    data: Optional[Any] = None
    error: Optional[dict] = None

def success_response(data: Any = None) -> dict:
    return {"success": True, "data": data}

def error_response(message: str, code: str = "ERROR") -> dict:
    return {"success": False, "error": {"code": code, "message": message}}
```

### 后端：全局异常处理器

```python
# main.py 或 api/__init__.py
from fastapi import Request
from fastapi.responses import JSONResponse
from .exceptions import APIException

@app.exception_handler(APIException)
async def api_exception_handler(request: Request, exc: APIException):
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "success": False,
            "error": {"code": exc.code, "message": exc.message}
        }
    )

@app.exception_handler(Exception)
async def generic_exception_handler(request: Request, exc: Exception):
    logger.exception("Unhandled exception")
    return JSONResponse(
        status_code=500,
        content={
            "success": False,
            "error": {"code": "INTERNAL_ERROR", "message": "服务器内部错误"}
        }
    )
```

---

## 3. UI 组件交互效果统一优化

### 设计原则

1. 所有组件引用 `designTokens.ts` 中的样式常量
2. 完整的交互状态：`hover:` / `active:` / `focus:` / `disabled:`
3. 统一过渡动画：`transition-all duration-200 ease-out`
4. 按下反馈：`active:scale-[0.98]`

### 组件优化清单

#### Button.tsx
- 已有基础交互，需补充 `active:scale-[0.98]` 按下反馈
- 增加 `focus-visible:ring-2` 用于键盘导航

#### Input.tsx
- 补充 `hover:border-neutral-300` 边框色变化
- 已有 focus 状态，无需改动

#### Modal.tsx
- 添加 `animate-scale-in` 进入动画
- 添加退出动画支持（可选）

#### Textarea.tsx
- 与 Input 保持一致的交互效果

#### Select.tsx
- 补充完整的 hover/focus/active 状态

#### Tag.tsx / Badge.tsx
- 补充 hover 状态（如果是可点击的）

### 统一的交互样式模式

```typescript
// 交互效果常量
export const interactionStyles = {
  // 按钮按下效果
  buttonPress: 'active:scale-[0.98]',
  // focus ring
  focusRing: 'focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-400',
  // hover 提升
  hoverLift: 'hover:shadow-sm hover:-translate-y-0.5',
  // 禁用状态
  disabled: 'disabled:opacity-50 disabled:cursor-not-allowed',
}
```

---

## 实施优先级

| 优先级 | 任务 | 预计时间 |
|--------|------|----------|
| P1 | 前端 Store 优化 - 添加 base.ts | 0.5 天 |
| P1 | 前端错误处理 - useErrorHandler | 0.5 天 |
| P1 | 后端异常体系 | 0.5 天 |
| P2 | UI 组件优化 - Button | 0.5 天 |
| P2 | UI 组件优化 - Input/Textarea/Select | 0.5 天 |
| P2 | UI 组件优化 - Modal 动画 | 0.5 天 |

**总计：约 3-4 天**

---

## 验收标准

1. **Store 优化**
   - [ ] base.ts 创建并导出公共工具函数
   - [ ] 各 Store 使用统一的命名规范

2. **错误处理**
   - [ ] 前端所有 try-catch 使用 useErrorHandler
   - [ ] 后端所有 API 返回统一格式
   - [ ] 全局异常处理器覆盖所有错误

3. **UI 优化**
   - [ ] 所有可点击元素有 hover/active 反馈
   - [ ] 所有输入框有 focus 状态
   - [ ] Modal 有进入/退出动画

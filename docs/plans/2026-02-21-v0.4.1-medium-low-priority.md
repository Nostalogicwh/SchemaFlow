# v0.4.1 ä¸­ä½ä¼˜å…ˆçº§é—®é¢˜å®æ–½è®¡åˆ’

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**ç›®æ ‡ï¼š** ä¿®å¤ v0.4.1 ç‰ˆæœ¬ä¸­çš„ä¸­ä½ä¼˜å…ˆçº§é—®é¢˜ï¼ŒåŒ…æ‹¬æ‰§è¡ŒæŒ‰é’®çŠ¶æ€ã€èŠ‚ç‚¹è‡ªå®šä¹‰åç§°ã€è¿çº¿åŠŸèƒ½å’Œç”¨æˆ·æç¤ºä¼˜åŒ–ã€‚

**æ¶æ„ï¼š**
- ä¸­ä¼˜å…ˆçº§é—®é¢˜èšç„¦åœ¨ UI/UX æ”¹è¿›ï¼Œæå‡ç”¨æˆ·æ“ä½œä½“éªŒ
- ä½ä¼˜å…ˆçº§é—®é¢˜æ¶‰åŠä»£ç è´¨é‡å’Œæ—¥å¿—å®Œå–„ï¼Œæé«˜ç³»ç»Ÿå¯ç»´æŠ¤æ€§
- æ‰€æœ‰æ”¹åŠ¨ä¿æŒå‘åå…¼å®¹ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½

**æŠ€æœ¯æ ˆï¼š**
- å‰ç«¯ï¼šReact + TypeScript + Zustand + @xyflow/react
- åç«¯ï¼šPython + FastAPI + asyncio

---

## ä¸­ä¼˜å…ˆçº§é—®é¢˜ 1: ä¿®å¤æ‰§è¡ŒæŒ‰é’®çŠ¶æ€é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
æ‰§è¡Œå®ŒæˆåæŒ‰é’®æ˜¾ç¤º"å®Œæˆ"ï¼Œç‚¹å‡»åä»ç„¶æ˜¾ç¤º"å®Œæˆ"ï¼Œç”¨æˆ·æ— æ³•å†æ¬¡æ‰§è¡Œå·¥ä½œæµã€‚

**æ–‡ä»¶ï¼š**
- ä¿®æ”¹ï¼š`frontend/src/components/Header.tsx:107-164`

**Step 1: åˆ†æå½“å‰çŠ¶æ€é€»è¾‘**

```typescript
// å½“å‰é€»è¾‘åœ¨ Header.tsx:177-187
const hasFailedNodes = Object.values(executionState.nodeStatuses).some((s) => s === 'failed')
const hasCompletedNodes = Object.values(executionState.nodeStatuses).some((s) => s === 'completed')

let executionStatus: ExecutionStatus = 'idle'
if (executionState.isRunning) {
  executionStatus = 'running'
} else if (hasFailedNodes) {
  executionStatus = 'error'
} else if (hasCompletedNodes) {
  executionStatus = 'success'
}
```

**é—®é¢˜ï¼š** ä¸€æ—¦æœ‰èŠ‚ç‚¹å®Œæˆï¼ŒçŠ¶æ€å°±å˜ä¸º 'success'ï¼Œå³ä½¿å·¥ä½œæµå·²ç»ç»“æŸï¼Œä¸‹æ¬¡ç‚¹å‡»ä¹Ÿä¸ä¼šé‡ç½®çŠ¶æ€ã€‚

**Step 2: ä¿®æ”¹çŠ¶æ€åˆ¤æ–­é€»è¾‘**

åœ¨ `frontend/src/components/Header.tsx` ä¸­ï¼Œä¿®æ”¹çŠ¶æ€åˆ¤æ–­é€»è¾‘ï¼Œæ·»åŠ çŠ¶æ€é‡ç½®æœºåˆ¶ï¼š

```typescript
// åœ¨ Header ç»„ä»¶å†…æ·»åŠ çŠ¶æ€è·Ÿè¸ª
const [lastExecutionId, setLastExecutionId] = useState<string | null>(null)

// ä¿®æ”¹çŠ¶æ€åˆ¤æ–­é€»è¾‘
let executionStatus: ExecutionStatus = 'idle'
const currentExecutionId = executionState.executionId

// å¦‚æœæ‰§è¡ŒIDå˜åŒ–ï¼Œè¡¨ç¤ºæ–°çš„æ‰§è¡Œï¼Œé‡ç½®çŠ¶æ€
if (lastExecutionId !== currentExecutionId) {
  setLastExecutionId(currentExecutionId)
}

if (executionState.isRunning) {
  executionStatus = 'running'
} else if (hasFailedNodes && currentExecutionId === lastExecutionId) {
  // åªæœ‰å½“å‰æ‰§è¡ŒIDåŒ¹é…æ—¶æ‰æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
  executionStatus = 'error'
} else if (!executionState.isRunning && !hasFailedNodes && hasCompletedNodes && currentExecutionId === lastExecutionId) {
  // æ‰§è¡Œå®Œæˆåï¼ŒçŸ­æš‚æ˜¾ç¤ºæˆåŠŸçŠ¶æ€ï¼Œç„¶åå…è®¸é‡æ–°æ‰§è¡Œ
  executionStatus = 'success'
}
```

**Step 3: ä¿®æ”¹ ExecuteButton çš„ success case è¡Œä¸º**

```typescript
case 'success':
  return (
    <Button
      onClick={onExecute}
      variant="primary"
      size="sm"
      icon={<Play className="w-4 h-4" />}
    >
      å†æ¬¡è¿è¡Œ
    </Button>
  )
```

**Step 4: å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨éªŒè¯**

```bash
cd frontend
npm run dev
```

**é¢„æœŸï¼š** æ‰§è¡Œå®Œæˆåï¼ŒæŒ‰é’®æ˜¾ç¤º"å†æ¬¡è¿è¡Œ"ï¼Œç‚¹å‡»åé‡æ–°æ‰§è¡Œå·¥ä½œæµã€‚

**Step 5: Commit**

```bash
git add frontend/src/components/Header.tsx
git commit -m "fix: ä¿®å¤æ‰§è¡ŒæŒ‰é’®çŠ¶æ€é—®é¢˜ï¼Œæ”¯æŒé‡æ–°æ‰§è¡Œå·¥ä½œæµ"
```

---

## ä¸­ä¼˜å…ˆçº§é—®é¢˜ 2: èŠ‚ç‚¹èƒ½å¤Ÿè‡ªå®šä¹‰åç§°

**é—®é¢˜æè¿°ï¼š**
å½“å‰èŠ‚ç‚¹ä½¿ç”¨é»˜è®¤æ ‡ç­¾ï¼ˆèŠ‚ç‚¹ç±»å‹åç§°ï¼‰ï¼Œç”¨æˆ·æ— æ³•è‡ªå®šä¹‰èŠ‚ç‚¹åç§°ã€‚

**æ–‡ä»¶ï¼š**
- ä¿®æ”¹ï¼š`frontend/src/components/FlowEditor/panels/NodePanel.tsx`
- ä¿®æ”¹ï¼š`frontend/src/components/FlowEditor/index.tsx:70-88` (flowToWorkflow å‡½æ•°)
- ä¿®æ”¹ï¼š`frontend/src/types/workflow.ts` (å¯èƒ½éœ€è¦æ‰©å±•ç±»å‹å®šä¹‰)

**Step 1: è¯»å– NodePanel ç»„ä»¶**

```bash
cat frontend/src/components/FlowEditor/panels/NodePanel.tsx
```

**Step 2: åœ¨ NodePanel ä¸­æ·»åŠ  label ç¼–è¾‘åŠŸèƒ½**

å¦‚æœ NodePanel ä¸­å·²æœ‰ config è¡¨å•ï¼Œæ·»åŠ  label è¾“å…¥æ¡†ï¼š

```typescript
// åœ¨è¡¨å•é¡¶éƒ¨æ·»åŠ  label è¾“å…¥
<div className="space-y-3">
  <div>
    <label className="block text-sm font-medium text-gray-700 mb-1">
      èŠ‚ç‚¹åç§°
    </label>
    <Input
      type="text"
      value={selectedNode.data.label}
      onChange={(e) => {
        onUpdateNode(selectedNode.id, {
          ...selectedNode.data.config,
          _label: e.target.value // ä¸´æ—¶å­˜å‚¨åœ¨ config ä¸­
        })
      }}
      placeholder="è‡ªå®šä¹‰èŠ‚ç‚¹åç§°"
      size="sm"
    />
  </div>

  {/* ç°æœ‰çš„ config è¡¨å•é¡¹ */}
</div>
```

**Step 3: ä¿®æ”¹ flowToWorkflow å‡½æ•°ä»¥æ”¯æŒè‡ªå®šä¹‰ label**

åœ¨ `frontend/src/components/FlowEditor/index.tsx` çš„ `flowToWorkflow` å‡½æ•°ä¸­ï¼š

```typescript
function flowToWorkflow(
  nodes: FlowNode[],
  edges: Edge[],
  baseWorkflow: Workflow
): Workflow {
  const workflowNodes: WorkflowNode[] = nodes.map((node) => {
    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰ label
    const customLabel = node.data.config?._label as string | undefined
    const finalLabel = customLabel || node.data.label || node.type!

    return {
      id: node.id,
      type: node.type!,
      config: {
        ...node.data.config,
        _label: customLabel // ä¿ç•™è‡ªå®šä¹‰ label
      },
      position: { x: node.position.x, y: node.position.y },
      label: finalLabel // ä½¿ç”¨æœ€ç»ˆ label
    }
  })
  // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
}
```

**Step 4: ä¿®æ”¹ workflowToFlow å‡½æ•°ä»¥åŠ è½½è‡ªå®šä¹‰ label**

åœ¨ `frontend/src/components/FlowEditor/index.tsx` çš„ `workflowToFlow` å‡½æ•°ä¸­ï¼š

```typescript
function workflowToFlow(workflow: Workflow): { nodes: FlowNode[]; edges: Edge[] } {
  const nodes: FlowNode[] = workflow.nodes.map((node, index) => {
    // ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ labelï¼Œå¦åˆ™ä½¿ç”¨ç±»å‹åç§°
    const label = node.label || node.type

    return {
      id: node.id,
      type: node.type,
      position: node.position ?? { x: 100 + index * 200, y: 100 + (index % 2) * 100 },
      data: {
        label: label,
        category: nodeCategoryMap[node.type] || 'base',
        config: node.config || {},
        status: 'idle' as NodeStatus,
      },
    }
  })
  // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
}
```

**Step 5: æµ‹è¯•èŠ‚ç‚¹è‡ªå®šä¹‰åç§°åŠŸèƒ½**

```bash
cd frontend
npm run dev
```

é¢„æœŸï¼š
1. é€‰ä¸­èŠ‚ç‚¹åï¼ŒNodePanel ä¸­æ˜¾ç¤º"èŠ‚ç‚¹åç§°"è¾“å…¥æ¡†
2. è¾“å…¥è‡ªå®šä¹‰åç§°åï¼ŒèŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾å®æ—¶æ›´æ–°
3. ä¿å­˜å·¥ä½œæµåï¼Œé‡æ–°åŠ è½½æ—¶ä¿ç•™è‡ªå®šä¹‰åç§°

**Step 6: Commit**

```bash
git add frontend/src/components/FlowEditor/panels/NodePanel.tsx frontend/src/components/FlowEditor/index.tsx
git commit -m "feat: æ”¯æŒèŠ‚ç‚¹è‡ªå®šä¹‰åç§°"
```

---

## ä¸­ä¼˜å…ˆçº§é—®é¢˜ 3: èŠ‚ç‚¹å·¦å³éƒ½è¦èƒ½è¿çº¿

**é—®é¢˜æè¿°ï¼š**
éªŒè¯å¹¶ç¡®ä¿èŠ‚ç‚¹å·¦å³ä¸¤ä¾§éƒ½æ”¯æŒè¿çº¿ã€‚

**æ–‡ä»¶ï¼š**
- æ£€æŸ¥ï¼š`frontend/src/components/FlowEditor/nodes/BaseNode.tsx:66-101`
- æ£€æŸ¥ï¼š`frontend/src/components/FlowEditor/index.tsx`

**Step 1: éªŒè¯ BaseNode ç»„ä»¶çš„ Handle é…ç½®**

```bash
grep -n "Handle" frontend/src/components/FlowEditor/nodes/BaseNode.tsx
```

å½“å‰é…ç½®åº”è¯¥å·²ç»æ”¯æŒï¼š
- `type="target"` `position={Position.Left}` (è¾“å…¥è¿æ¥ç‚¹)
- `type="source"` `position={Position.Right}` (è¾“å‡ºè¿æ¥ç‚¹)

**Step 2: æµ‹è¯•è¿çº¿åŠŸèƒ½**

```bash
cd frontend
npm run dev
```

éªŒè¯ï¼š
1. ä»èŠ‚ç‚¹å³ä¾§æ‹–åŠ¨è¿çº¿åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹å·¦ä¾§ â†’ åº”è¯¥èƒ½æˆåŠŸè¿æ¥
2. ä»èŠ‚ç‚¹å·¦ä¾§æ‹–åŠ¨è¿çº¿åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹å³ä¾§ â†’ åº”è¯¥èƒ½æˆåŠŸè¿æ¥
3. è¿çº¿åï¼ŒèŠ‚ç‚¹æ‰§è¡Œé¡ºåºåº”è¯¥æŒ‰ç…§ DAG é€»è¾‘

**Step 3: å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œä¿®å¤ Handle é…ç½®**

å¦‚æœè¿çº¿åŠŸèƒ½æœ‰é—®é¢˜ï¼Œæ£€æŸ¥ ReactFlow é…ç½®ï¼š

```typescript
// åœ¨ FlowEditor/index.tsx çš„ ReactFlow ç»„ä»¶ä¸­ç¡®ä¿ï¼š
<ReactFlow
  nodes={nodes}
  edges={edges}
  onConnect={onConnect} // ç¡®ä¿ onConnect æ­£ç¡®é…ç½®
  // ... å…¶ä»–é…ç½®
>
```

**Step 4: Commit (å¦‚æœéœ€è¦ä¿®æ”¹)**

```bash
git add frontend/src/components/FlowEditor/nodes/BaseNode.tsx frontend/src/components/FlowEditor/index.tsx
git commit -m "fix: ç¡®ä¿èŠ‚ç‚¹å·¦å³ä¸¤ä¾§éƒ½æ”¯æŒè¿çº¿"
```

---

## ä¸­ä¼˜å…ˆçº§é—®é¢˜ 4: æ·»åŠ ç”¨æˆ·å‹å¥½çš„æç¤º

**é—®é¢˜æè¿°ï¼š**
åœ¨å¯èƒ½å¼•èµ·æ­§ä¹‰çš„åœ°æ–¹æ·»åŠ å‹å¥½çš„æç¤ºä¿¡æ¯ã€‚

**æ–‡ä»¶ï¼š**
- ä¿®æ”¹ï¼š`frontend/src/components/FlowEditor/panels/Toolbar.tsx`
- ä¿®æ”¹ï¼š`frontend/src/components/FlowEditor/panels/NodePanel.tsx`
- ä¿®æ”¹ï¼š`frontend/src/components/Header.tsx`

**Step 1: åœ¨ Toolbar ä¸­æ·»åŠ æ‹–æ”¾æç¤º**

```typescript
// åœ¨ Toolbar ç»„ä»¶ä¸­ï¼Œåœ¨èŠ‚ç‚¹å·¥å…·æ åŒºåŸŸä¸Šæ–¹æ·»åŠ æç¤º
<div className="p-3 space-y-4 overflow-y-auto h-full bg-neutral-50/50">
  {/* AI ç¼–æ’åŒºåŸŸ - ç°æœ‰ä»£ç  */}

  {/* èŠ‚ç‚¹å·¥å…·æ  */}
  <div>
    <h3 className="font-semibold text-sm text-neutral-600 px-1 mb-2 flex items-center gap-1.5">
      <span className="w-1 h-4 bg-blue-500 rounded-full" />
      èŠ‚ç‚¹å·¥å…·æ 
    </h3>

    {/* æ·»åŠ æç¤ºä¿¡æ¯ */}
    {nodes.length === 0 && (
      <div className="mb-2 p-2 bg-blue-50 border border-blue-200 rounded-lg">
        <p className="text-xs text-blue-700">
          ğŸ’¡ å°†èŠ‚ç‚¹æ‹–æ‹½åˆ°å³ä¾§ç”»å¸ƒä¸­ï¼Œç„¶åé€šè¿‡è¿æ¥ç‚¹åˆ›å»ºå·¥ä½œæµ
        </p>
      </div>
    )}

    {/* ç°æœ‰èŠ‚ç‚¹åˆ—è¡¨ */}
  </div>
</div>
```

**Step 2: åœ¨ NodePanel ä¸­æ·»åŠ è¡¨å•å­—æ®µè¯´æ˜**

```typescript
// åœ¨ NodePanel ä¸­ï¼Œä¸ºæ¯ä¸ªè¡¨å•å­—æ®µæ·»åŠ å¸®åŠ©æ–‡æœ¬
{selectedNode && (
  <div className="p-3 space-y-4">
    {/* èŠ‚ç‚¹åç§°å­—æ®µ */}
    <div>
      <div className="flex items-center justify-between mb-1">
        <label className="block text-sm font-medium text-gray-700">
          èŠ‚ç‚¹åç§°
        </label>
        <span className="text-xs text-gray-500">
          è‡ªå®šä¹‰æ˜¾ç¤ºåç§°
        </span>
      </div>
      <Input ... />
    </div>

    {/* å…¶ä»–é…ç½®å­—æ®µ */}
    {/* æ¯ä¸ªå­—æ®µéƒ½æ·»åŠ è¯´æ˜æ–‡å­— */}
  </div>
)}
```

**Step 3: åœ¨ Header ä¸­æ·»åŠ æ‰§è¡Œæ¨¡å¼è¯´æ˜**

```typescript
// åœ¨ Header ç»„ä»¶ä¸­ï¼Œä¸ºæ‰§è¡Œæ¨¡å¼åˆ‡æ¢æ·»åŠ æç¤º
<div className="flex items-center gap-2">
  <ExecutionModeToggle mode={executionMode} onChange={setExecutionMode} />

  {/* æ·»åŠ å·¥å…·æç¤º */}
  <div className="relative group">
    <button className="text-gray-400 hover:text-gray-600">
      <Info className="w-4 h-4" />
    </button>
    <div className="absolute right-0 mt-2 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
      <p className="font-semibold mb-1">æ‰§è¡Œæ¨¡å¼è¯´æ˜</p>
      <p className="mb-1"><strong>åå°æ¨¡å¼ï¼š</strong>æ— ç•Œé¢è¿è¡Œï¼Œé€‚åˆæ‰¹é‡ä»»åŠ¡</p>
      <p><strong>å‰å°æ¨¡å¼ï¼š</strong>æ˜¾ç¤ºæµè§ˆå™¨çª—å£ï¼Œé€‚åˆè°ƒè¯•å’Œè§‚å¯Ÿ</p>
    </div>
  </div>

  <ExecuteButton status={executionStatus} onExecute={onExecute} onStop={onStop} />
</div>
```

**Step 4: æ·»åŠ é”™è¯¯æç¤ºå’ŒæˆåŠŸåé¦ˆ**

åœ¨ç›¸å…³æ“ä½œä¸­æ·»åŠ  toast æç¤ºï¼š

```typescript
// åœ¨ä¿å­˜æ“ä½œä¸­
const handleSave = useCallback(() => {
  if (!workflow || !onSave) return
  const updatedWorkflow = flowToWorkflow(nodes, edges, workflow)
  onSave(updatedWorkflow)
  toast.success('å·¥ä½œæµå·²ä¿å­˜', { duration: 2000 })
}, [workflow, nodes, edges, onSave, toast])
```

**Step 5: æµ‹è¯•æç¤ºåŠŸèƒ½**

```bash
cd frontend
npm run dev
```

éªŒè¯ï¼š
1. ç©ºç”»å¸ƒæ—¶æ˜¾ç¤ºæ‹–æ”¾æç¤º
2. èŠ‚ç‚¹é…ç½®è¡¨å•æ˜¾ç¤ºå­—æ®µè¯´æ˜
3. æ‰§è¡Œæ¨¡å¼æœ‰å·¥å…·æç¤ºè¯´æ˜
4. ä¿å­˜ç­‰æ“ä½œæœ‰æˆåŠŸ/å¤±è´¥åé¦ˆ

**Step 6: Commit**

```bash
git add frontend/src/components/FlowEditor/panels/Toolbar.tsx frontend/src/components/FlowEditor/panels/NodePanel.tsx frontend/src/components/Header.tsx
git commit -m "feat: æ·»åŠ ç”¨æˆ·å‹å¥½çš„æç¤ºä¿¡æ¯"
```

---

## ä½ä¼˜å…ˆçº§é—®é¢˜ 1: æ¸…ç†æ— æ„ä¹‰ä»£ç 

**é—®é¢˜æè¿°ï¼š**
æ¸…ç†ä»£ç åº“ä¸­æœªä½¿ç”¨çš„ä»£ç å’Œæ³¨é‡Šã€‚

**æ–‡ä»¶ï¼š**
- æ£€æŸ¥ï¼šæ‰€æœ‰å‰ç«¯å’Œåç«¯æ–‡ä»¶

**Step 1: ä½¿ç”¨ grep æŸ¥æ‰¾æœªä½¿ç”¨çš„å¯¼å…¥å’Œä»£ç **

```bash
# æŸ¥æ‰¾æœªä½¿ç”¨çš„å¯¼å…¥ï¼ˆESLint ä¼šæ£€æµ‹ï¼Œä½†å¯ä»¥æ‰‹åŠ¨æ£€æŸ¥ï¼‰
cd frontend
npm run lint -- --fix

cd ../backend
# Python æ£€æŸ¥æœªä½¿ç”¨çš„å¯¼å…¥
python -m py_compile backend/engine/*.py
```

**Step 2: æ£€æŸ¥ console.log å’Œè°ƒè¯•ä»£ç **

```bash
# æŸ¥æ‰¾å‰ç«¯ä¸­çš„ console.log
grep -r "console.log" frontend/src --exclude-dir=node_modules

# æŸ¥æ‰¾åç«¯ä¸­çš„è°ƒè¯•æ‰“å°
grep -r "print(" backend --exclude-dir=__pycache__
```

**Step 3: æ¸…ç†æ‰¾åˆ°çš„è°ƒè¯•ä»£ç **

é€ä¸€æ£€æŸ¥å¹¶ç§»é™¤ä¸å¿…è¦çš„ console.log å’Œ print è¯­å¥ï¼Œä¿ç•™æœ‰æ„ä¹‰çš„é”™è¯¯æ—¥å¿—ã€‚

**Step 4: æ£€æŸ¥æ³¨é‡Šæ‰çš„ä»£ç å—**

```bash
# æŸ¥æ‰¾è¢«æ³¨é‡Šçš„å¤§æ®µä»£ç 
grep -r "^[[:space:]]*//.*{$\|^[[:space:]]*//.*function\|^[[:space:]]*#.*def\|^[[:space:]]*#.*class" frontend/src backend --exclude-dir=node_modules --exclude-dir=__pycache__
```

æ¸…ç†æˆ–æ¢å¤æœ‰ç”¨çš„æ³¨é‡Šä»£ç ï¼Œåˆ é™¤æ— ç”¨çš„æ³¨é‡Šä»£ç å—ã€‚

**Step 5: è¿è¡Œæµ‹è¯•ç¡®ä¿æ¸…ç†æ²¡æœ‰ç ´ååŠŸèƒ½**

```bash
cd frontend
npm run test

cd ../backend
pytest
```

**Step 6: Commit**

```bash
git add frontend/src backend
git commit -m "refactor: æ¸…ç†æ— æ„ä¹‰çš„è°ƒè¯•ä»£ç å’Œæ³¨é‡Š"
```

---

## ä½ä¼˜å…ˆçº§é—®é¢˜ 2: åç«¯æœåŠ¡è¡¥å……æ—¥å¿—

**é—®é¢˜æè¿°ï¼š**
åœ¨åç«¯å…³é”®æµç¨‹ä¸­æ·»åŠ è¯¦ç»†çš„æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œç›‘æ§ã€‚

**æ–‡ä»¶ï¼š**
- ä¿®æ”¹ï¼š`backend/engine/executor.py`
- ä¿®æ”¹ï¼š`backend/engine/browser_manager.py`
- ä¿®æ”¹ï¼š`backend/engine/context.py`

**Step 1: åœ¨ executor.py ä¸­æ·»åŠ æ—¥å¿—**

```python
import logging

# åœ¨æ–‡ä»¶é¡¶éƒ¨é…ç½®æ—¥å¿—
logger = logging.getLogger(__name__)

# åœ¨ execute æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—
async def execute(
    self,
    workflow: Dict[str, Any],
    websocket=None,
    browser=None,
    execution_id: str = None,
    headless: bool = True
) -> ExecutionContext:
    if execution_id is None:
        execution_id = str(uuid.uuid4())

    logger.info(f"å¼€å§‹æ‰§è¡Œå·¥ä½œæµ: {execution_id}, workflow_id={workflow.get('id')}, headless={headless}")

    context = ExecutionContext(
        execution_id=execution_id,
        workflow_id=workflow["id"],
        browser=browser,
        websocket=websocket,
        data_dir=self.data_dir
    )

    async with self._get_lock():
        self.active_executions[execution_id] = context

    try:
        await self._run_workflow(context, workflow, headless=headless)
        logger.info(f"å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ: {execution_id}")
    except Exception as e:
        context.status = ExecutionStatus.FAILED
        context.error = str(e)
        logger.error(f"å·¥ä½œæµæ‰§è¡Œå¤±è´¥: {execution_id}, error={str(e)}", exc_info=True)
        # ... å…¶ä½™ä»£ç 
```

**Step 2: åœ¨ _run_workflow æ–¹æ³•ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—**

```python
async def _run_workflow(
    self,
    context: ExecutionContext,
    workflow: Dict[str, Any],
    headless: bool = True
):
    context.status = ExecutionStatus.RUNNING
    context.start_time = datetime.now()
    logger.info(f"[{context.execution_id}] å·¥ä½œæµå¼€å§‹è¿è¡Œ")

    browser_mgr = BrowserManager()
    context._browser_mgr = browser_mgr
    await browser_mgr.connect(context, headless)
    logger.info(f"[{context.execution_id}] æµè§ˆå™¨è¿æ¥å®Œæˆ")

    execution_order = topological_sort(
        workflow.get("nodes", []),
        workflow.get("edges", [])
    )
    logger.info(f"[{context.execution_id}] æ‰§è¡Œé¡ºåº: {execution_order}")

    nodes_map = {node["id"]: node for node in workflow.get("nodes", [])}

    # ... å…¶ä½™ä»£ç 

    for node_id in execution_order:
        if context.status == ExecutionStatus.CANCELLED:
            logger.info(f"[{context.execution_id}] å·¥ä½œæµå·²å–æ¶ˆ")
            break

        node = nodes_map.get(node_id)
        if not node:
            logger.warning(f"[{context.execution_id}] èŠ‚ç‚¹ä¸å­˜åœ¨: {node_id}")
            continue

        node_type = node.get("type")
        config = node.get("config", {})
        node_label = node.get("label", node_type)

        context.current_node_id = node_id
        logger.info(f"[{context.execution_id}] å¼€å§‹æ‰§è¡ŒèŠ‚ç‚¹: {node_id} ({node_label}, type={node_type})")

        # ... èŠ‚ç‚¹æ‰§è¡Œé€»è¾‘

        try:
            result = await execute_func(context, resolved_config)
            logger.info(f"[{context.execution_id}] èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ: {node_id}")
            # ... æˆåŠŸå¤„ç†
        except Exception as e:
            logger.error(f"[{context.execution_id}] èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥: {node_id}, error={str(e)}", exc_info=True)
            # ... é”™è¯¯å¤„ç†
            raise

    context.status = ExecutionStatus.COMPLETED
    context.end_time = datetime.now()
    duration = (context.end_time - context.start_time).total_seconds()
    logger.info(f"[{context.execution_id}] å·¥ä½œæµæ‰§è¡Œå®Œæˆ, è€—æ—¶: {duration:.2f}ç§’")

    # ... å…¶ä½™ä»£ç 
```

**Step 3: åœ¨ browser_manager.py ä¸­æ·»åŠ æ—¥å¿—**

```python
import logging

logger = logging.getLogger(__name__)

# åœ¨å…³é”®æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—
async def connect(self, context: ExecutionContext, headless: bool = True):
    logger.info(f"[{context.execution_id}] å¼€å§‹è¿æ¥æµè§ˆå™¨, headless={headless}")

    # ... è¿æ¥é€»è¾‘

    logger.info(f"[{context.execution_id}] æµè§ˆå™¨è¿æ¥æˆåŠŸ, CDPåœ°å€: {self.cdp_url}")

async def cleanup(self, context: ExecutionContext):
    logger.info(f"[{context.execution_id}] å¼€å§‹æ¸…ç†æµè§ˆå™¨èµ„æº")

    # ... æ¸…ç†é€»è¾‘

    logger.info(f"[{context.execution_id}] æµè§ˆå™¨èµ„æºæ¸…ç†å®Œæˆ")
```

**Step 4: åœ¨ context.py ä¸­æ·»åŠ æ—¥å¿—**

```python
import logging

logger = logging.getLogger(__name__)

# åœ¨æ—¥å¿—æ–¹æ³•ä¸­æ·»åŠ æ›´è¯¦ç»†çš„ä¿¡æ¯
async def log(self, level: str, message: str):
    timestamp = datetime.now().isoformat()
    log_entry = {
        "type": "log",
        "level": level,
        "message": message,
        "timestamp": timestamp,
        "node_id": self.current_node_id
    }
    self.logs.append(log_entry)

    if self.websocket:
        try:
            await self.websocket.send_json(log_entry)
        except Exception as e:
            logger.error(f"[{self.execution_id}] å‘é€æ—¥å¿—å¤±è´¥: {e}")

    # æœ¬åœ°ä¹Ÿè®°å½•æ—¥å¿—
    log_func = getattr(logger, level.lower(), logger.info)
    log_func(f"[{self.execution_id}][{self.current_node_id}] {message}")
```

**Step 5: é…ç½®åç«¯æ—¥å¿—çº§åˆ«**

åœ¨ `backend/main.py` æˆ–ç›¸å…³é…ç½®æ–‡ä»¶ä¸­è®¾ç½®æ—¥å¿—çº§åˆ«ï¼š

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)
```

**Step 6: æµ‹è¯•æ—¥å¿—è¾“å‡º**

```bash
cd backend
# è¿è¡Œä¸€ä¸ªç®€å•çš„å·¥ä½œæµï¼ŒæŸ¥çœ‹æ—¥å¿—è¾“å‡º
python main.py
```

**Step 7: Commit**

```bash
git add backend/engine/executor.py backend/engine/browser_manager.py backend/engine/context.py
git commit -m "feat: åç«¯æœåŠ¡è¡¥å……è¯¦ç»†æ—¥å¿—"
```

---

## ä½ä¼˜å…ˆçº§é—®é¢˜ 3: ä¿®å¤å·¥ä½œæµåœæ­¢æŒ‰é’®æ— æ•ˆ

**é—®é¢˜æè¿°ï¼š**
ç‚¹å‡»åœæ­¢æŒ‰é’®åï¼Œå·¥ä½œæµæ²¡æœ‰æ­£ç¡®åœæ­¢ã€‚

**æ–‡ä»¶ï¼š**
- ä¿®æ”¹ï¼š`backend/engine/executor.py:233-248`
- ä¿®æ”¹ï¼š`frontend/src/hooks/useExecution.ts:104-106`
- ä¿®æ”¹ï¼š`frontend/src/components/Header.tsx`

**Step 1: åˆ†æåœæ­¢æµç¨‹**

å‰ç«¯è°ƒç”¨ï¼š
```typescript
// useExecution.ts
const stopExecution = useCallback(() => {
  send({ type: 'stop_execution' })
}, [send])
```

åç«¯æ¥æ”¶ï¼š
```python
# executor.py
async def stop(self, execution_id: str):
    async with self._get_lock():
        context = self.active_executions.get(execution_id)
        if context:
            context.status = ExecutionStatus.CANCELLED
```

**Step 2: ä¿®å¤åç«¯åœæ­¢é€»è¾‘**

åœ¨ `backend/engine/executor.py` çš„ `_run_workflow` æ–¹æ³•ä¸­ï¼Œç¡®ä¿æ£€æŸ¥å–æ¶ˆçŠ¶æ€ï¼š

```python
async def _run_workflow(
    self,
    context: ExecutionContext,
    workflow: Dict[str, Any],
    headless: bool = True
):
    # ... ç°æœ‰ä»£ç 

    for node_id in execution_order:
        # åœ¨å¾ªç¯å¼€å§‹æ—¶æ£€æŸ¥å–æ¶ˆçŠ¶æ€
        if context.status == ExecutionStatus.CANCELLED:
            logger.info(f"[{context.execution_id}] å·¥ä½œæµå·²å–æ¶ˆ")
            # å‘é€å–æ¶ˆæ¶ˆæ¯
            if context.websocket:
                await context.websocket.send_json({
                    "type": WSMessageType.EXECUTION_CANCELLED.value,
                    "execution_id": context.execution_id
                })
            break

        # ... èŠ‚ç‚¹æ‰§è¡Œé€»è¾‘

        # åœ¨èŠ‚ç‚¹æ‰§è¡Œå‰ä¹Ÿæ£€æŸ¥å–æ¶ˆçŠ¶æ€
        if context.status == ExecutionStatus.CANCELLED:
            logger.info(f"[{context.execution_id}] èŠ‚ç‚¹æ‰§è¡Œå‰æ£€æµ‹åˆ°å–æ¶ˆ: {node_id}")
            break

        try:
            result = await execute_func(context, resolved_config)
            # ... æˆåŠŸå¤„ç†
        except Exception as e:
            # ... é”™è¯¯å¤„ç†
            raise

    # ... å…¶ä½™ä»£ç 

    # å¦‚æœè¢«å–æ¶ˆï¼Œä¸è®¾ç½®ä¸º COMPLETED
    if context.status != ExecutionStatus.CANCELLED:
        context.status = ExecutionStatus.COMPLETED
        context.end_time = datetime.now()

        if context.websocket:
            await context.websocket.send_json({
                "type": WSMessageType.EXECUTION_COMPLETE.value,
                "execution_id": context.execution_id,
                "success": context.status == ExecutionStatus.COMPLETED,
                "duration": (context.end_time - context.start_time).total_seconds() if context.end_time else 0,
                "logs": context.logs
            })
```

**Step 3: ä¿®å¤åç«¯ stop æ–¹æ³•**

åœ¨ `backend/engine/executor.py` ä¸­ï¼Œç¡®ä¿åœæ­¢æ—¶æ¸…ç†èµ„æºï¼š

```python
async def stop(self, execution_id: str):
    logger.info(f"æ”¶åˆ°åœæ­¢è¯·æ±‚: {execution_id}")

    async with self._get_lock():
        context = self.active_executions.get(execution_id)
        if context:
            context.status = ExecutionStatus.CANCELLED
            logger.info(f"[{execution_id}] å·¥ä½œæµçŠ¶æ€å·²è®¾ç½®ä¸º CANCELLED")

            if context.websocket:
                try:
                    await context.websocket.send_json({
                        "type": WSMessageType.EXECUTION_CANCELLED.value,
                        "execution_id": execution_id
                    })
                    logger.info(f"[{execution_id}] å·²å‘é€å–æ¶ˆæ¶ˆæ¯åˆ°å‰ç«¯")
                except ConnectionClosed:
                    logger.warning(f"[{execution_id}] WebSocketè¿æ¥å·²å…³é—­ï¼Œæ— æ³•å‘é€å–æ¶ˆæ¶ˆæ¯")
                except WebSocketDisconnect:
                    logger.warning(f"[{execution_id}] WebSocketå·²æ–­å¼€ï¼Œæ— æ³•å‘é€å–æ¶ˆæ¶ˆæ¯")

            # ç«‹å³æ¸…ç†æµè§ˆå™¨èµ„æº
            browser_mgr = getattr(context, '_browser_mgr', None)
            if browser_mgr:
                await browser_mgr.cleanup(context)
                logger.info(f"[{execution_id}] æµè§ˆå™¨èµ„æºå·²æ¸…ç†")
        else:
            logger.warning(f"æ‰§è¡ŒIDä¸å­˜åœ¨: {execution_id}")
```

**Step 4: ä¿®æ”¹å‰ç«¯ ExecuteButton çš„è¡Œä¸º**

åœ¨ `frontend/src/components/Header.tsx` ä¸­ï¼Œç¡®ä¿åœæ­¢æŒ‰é’®æ­£ç¡®è§¦å‘åœæ­¢ï¼š

```typescript
function ExecuteButton({
  status,
  onExecute,
  onStop,
}: {
  status: ExecutionStatus
  onExecute: () => void
  onStop: () => void
}) {
  switch (status) {
    case 'running':
      return (
        <Button
          onClick={onStop} // ç¡®ä¿è°ƒç”¨ onStop
          variant="secondary"
          size="sm"
          loading={false} // ç§»é™¤ loadingï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®
          icon={<Square className="w-4 h-4" />}
        >
          åœæ­¢
        </Button>
      )
    // ... å…¶ä»–çŠ¶æ€
  }
}
```

**Step 5: ç¡®ä¿å‰ç«¯æ­£ç¡®è°ƒç”¨ stopExecution**

åœ¨ `frontend/src/App.tsx` æˆ–ä½¿ç”¨ useExecution çš„åœ°æ–¹ï¼Œç¡®ä¿åœæ­¢é€»è¾‘æ­£ç¡®ï¼š

```typescript
const handleStop = useCallback(() => {
  stopExecution()
  toast.info('æ­£åœ¨åœæ­¢å·¥ä½œæµ...')
}, [stopExecution, toast])
```

**Step 6: æµ‹è¯•åœæ­¢åŠŸèƒ½**

```bash
cd frontend
npm run dev

cd ../backend
python main.py
```

éªŒè¯ï¼š
1. å¯åŠ¨ä¸€ä¸ªè€—æ—¶çš„å·¥ä½œæµ
2. ç‚¹å‡»"åœæ­¢"æŒ‰é’®
3. å·¥ä½œæµåº”è¯¥ç«‹å³åœæ­¢ï¼Œä¸å†æ‰§è¡Œåç»­èŠ‚ç‚¹
4. æµè§ˆå™¨èµ„æºåº”è¯¥è¢«æ­£ç¡®æ¸…ç†
5. å‰ç«¯æ˜¾ç¤ºå–æ¶ˆçŠ¶æ€

**Step 7: Commit**

```bash
git add backend/engine/executor.py frontend/src/hooks/useExecution.ts frontend/src/components/Header.tsx
git commit -m "fix: ä¿®å¤å·¥ä½œæµåœæ­¢æŒ‰é’®æ— æ•ˆé—®é¢˜"
```

---

## å®Œæˆæ‰€æœ‰ä»»åŠ¡åçš„æ€»ç»“

åœ¨å®Œæˆä»¥ä¸Šæ‰€æœ‰ä»»åŠ¡åï¼š

1. æ‰§è¡ŒæŒ‰é’®çŠ¶æ€æ­£å¸¸ï¼Œæ”¯æŒé‡æ–°æ‰§è¡Œ
2. èŠ‚ç‚¹å¯ä»¥è‡ªå®šä¹‰åç§°
3. èŠ‚ç‚¹å·¦å³ä¸¤ä¾§éƒ½æ”¯æŒè¿çº¿
4. æ·»åŠ äº†å‹å¥½çš„ç”¨æˆ·æç¤º
5. æ¸…ç†äº†æ— æ„ä¹‰çš„ä»£ç 
6. åç«¯æœåŠ¡æœ‰è¯¦ç»†çš„æ—¥å¿—
7. å·¥ä½œæµåœæ­¢åŠŸèƒ½æ­£å¸¸

æœ€åè¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼š

```bash
cd frontend
npm run test
npm run lint
npm run typecheck

cd ../backend
pytest
```

å¦‚æœæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæäº¤æœ€ç»ˆç‰ˆæœ¬ï¼š

```bash
git commit -m "chore: v0.4.1 ä¸­ä½ä¼˜å…ˆçº§é—®é¢˜å…¨éƒ¨å®Œæˆ"
```

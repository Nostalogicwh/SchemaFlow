# v0.4.2 重构优化实施计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**目标：** 优化前端状态管理、统一前后端错误处理、统一 UI 组件交互效果

**架构：** 
- 前端：添加 stores/base.ts 公共模式，创建 useErrorHandler hook
- 后端：创建统一异常类和响应格式，添加全局异常处理器
- UI：基于 designTokens 统一所有组件的交互状态

**技术栈：**
- 前端：React + Zustand + TypeScript
- 后端：Python + FastAPI

---

## Task 1: 创建 stores/base.ts 公共模式

**文件：**
- 创建：`frontend/src/stores/base.ts`
- 修改：`frontend/src/stores/index.ts`

**Step 1: 创建 base.ts 公共工具函数**

```typescript
// frontend/src/stores/base.ts
import type { StateCreator } from 'zustand'

/**
 * 异步 Action 包装器选项
 */
export interface AsyncActionOptions<T> {
  onStart?: () => void
  onSuccess?: (result: T) => void
  onError?: (error: Error) => void
}

/**
 * 创建异步 Action，自动处理错误
 */
export function createAsyncAction<T, Args extends unknown[]>(
  fn: (...args: Args) => Promise<T>,
  options?: AsyncActionOptions<T>
) {
  return async (...args: Args): Promise<T | null> => {
    try {
      options?.onStart?.()
      const result = await fn(...args)
      options?.onSuccess?.(result)
      return result
    } catch (error) {
      options?.onError?.(error as Error)
      return null
    }
  }
}

/**
 * 创建带加载状态的异步 Action
 */
export function createLoadingAsyncAction<T, Args extends unknown[]>(
  set: (partial: Record<string, unknown>) => void,
  fn: (...args: Args) => Promise<T>,
  options?: AsyncActionOptions<T> & { loadingKey?: string }
) {
  const loadingKey = options?.loadingKey || 'isLoading'
  return async (...args: Args): Promise<T | null> => {
    try {
      set({ [loadingKey]: true })
      options?.onStart?.()
      const result = await fn(...args)
      options?.onSuccess?.(result)
      return result
    } catch (error) {
      options?.onError?.(error as Error)
      return null
    } finally {
      set({ [loadingKey]: false })
    }
  }
}

/**
 * Store 命名规范常量
 * 
 * 命名规范：
 * - 设置单个值：set* (如 setConnected, setRunning)
 * - 更新部分值：update* (如 updateWorkflow)
 * - 重置状态：reset
 * - 异步操作：动词 + Async 或直接动词 (如 fetchWorkflow, saveWorkflow)
 */
export const STORE_NAMING = {
  SET_PREFIX: 'set',
  UPDATE_PREFIX: 'update',
  RESET_ACTION: 'reset',
} as const
```

**Step 2: 更新 stores/index.ts 导出**

```typescript
// frontend/src/stores/index.ts
export { useWorkflowStore } from './workflowStore'
export { useExecutionStore } from './executionStore'
export { useUIStore, toast, confirm } from './uiStore'
export { createAsyncAction, createLoadingAsyncAction } from './base'
```

**Step 3: 验证导出正确**

```bash
cd frontend && npm run build
```

预期：无错误

**Step 4: Commit**

```bash
git add frontend/src/stores/base.ts frontend/src/stores/index.ts
git commit -m "feat(store): 添加公共模式 base.ts"
```

---

## Task 2: 创建 useErrorHandler Hook

**文件：**
- 创建：`frontend/src/hooks/useErrorHandler.ts`
- 修改：`frontend/src/hooks/index.ts` (如果存在)

**Step 1: 创建 useErrorHandler hook**

```typescript
// frontend/src/hooks/useErrorHandler.ts
import { useCallback } from 'react'
import { toast } from '@/stores/uiStore'

/**
 * 统一错误处理 Hook
 * 
 * 用法：
 * const handleError = useErrorHandler()
 * try {
 *   await someAsyncOperation()
 * } catch (e) {
 *   handleError(e, '操作失败')
 * }
 */
export function useErrorHandler() {
  return useCallback((error: unknown, fallbackMessage = '操作失败') => {
    let message: string
    
    if (error instanceof Error) {
      message = error.message
    } else if (typeof error === 'string') {
      message = error
    } else if (error && typeof error === 'object' && 'message' in error) {
      message = String((error as { message: unknown }).message)
    } else {
      message = fallbackMessage
    }
    
    console.error('[Error]', error)
    toast.error(message)
  }, [])
}

/**
 * 包装异步函数，自动处理错误
 */
export function withErrorHandler<T extends (...args: unknown[]) => Promise<unknown>>(
  fn: T,
  handleError: (error: unknown, fallback: string) => void,
  fallbackMessage: string
): T {
  return (async (...args: Parameters<T>) => {
    try {
      return await fn(...args)
    } catch (error) {
      handleError(error, fallbackMessage)
      throw error
    }
  }) as T
}

export default useErrorHandler
```

**Step 2: 创建 hooks/index.ts (如果不存在)**

检查是否存在，如果不存在则创建：

```bash
ls frontend/src/hooks/index.ts 2>/dev/null || echo "not exists"
```

如果不存在，创建：

```typescript
// frontend/src/hooks/index.ts
export { useExecution } from './useExecution'
export { useWebSocket } from './useWebSocket'
export { useErrorHandler, withErrorHandler } from './useErrorHandler'
```

**Step 3: 验证编译**

```bash
cd frontend && npm run build
```

**Step 4: Commit**

```bash
git add frontend/src/hooks/useErrorHandler.ts frontend/src/hooks/index.ts
git commit -m "feat(hooks): 添加 useErrorHandler 统一错误处理"
```

---

## Task 3: 重构 App.tsx 使用 useErrorHandler

**文件：**
- 修改：`frontend/src/App.tsx`

**Step 1: 在 App.tsx 中引入 useErrorHandler 并替换错误处理**

修改 `frontend/src/App.tsx`，在文件顶部添加导入：

```typescript
import { useErrorHandler } from '@/hooks/useErrorHandler'
```

在 App 组件内添加：

```typescript
const handleError = useErrorHandler()
```

替换 handleSelectWorkflow：

```typescript
const handleSelectWorkflow = useCallback(
  async (id: string) => {
    try {
      await useWorkflowStore.getState().selectWorkflow(id)
      resetExecution()
    } catch (error) {
      handleError(error, '加载工作流失败')
    }
  },
  [resetExecution, handleError]
)
```

替换 handleCreateWorkflow：

```typescript
const handleCreateWorkflow = useCallback(async () => {
  const name = prompt('请输入工作流名称:')
  if (!name) return

  try {
    await useWorkflowStore.getState().createWorkflow(name)
  } catch (error) {
    handleError(error, '创建工作流失败')
  }
}, [handleError])
```

替换 handleSaveWorkflow：

```typescript
const handleSaveWorkflow = useCallback(
  async (workflow: typeof currentWorkflow) => {
    if (!workflow) return
    try {
      await saveWorkflow(workflow)
      toast.success('保存成功')
    } catch (error) {
      handleError(error, '保存工作流失败')
    }
  },
  [saveWorkflow, handleError]
)
```

替换 handleExecute：

```typescript
const handleExecute = useCallback(async () => {
  if (!selectedId) return

  try {
    const { execution_id } = await workflowApi.execute(selectedId)
    connect(execution_id, selectedId)
    setShowPanel(true)
    setTimeout(() => startExecution(selectedId, executionMode), 500)
  } catch (error) {
    handleError(error, '执行工作流失败')
  }
}, [selectedId, connect, startExecution, executionMode, setShowPanel, handleError])
```

**Step 2: 验证编译**

```bash
cd frontend && npm run build
```

**Step 3: Commit**

```bash
git add frontend/src/App.tsx
git commit -m "refactor(app): 使用 useErrorHandler 统一错误处理"
```

---

## Task 4: 创建后端异常体系

**文件：**
- 创建：`backend/api/exceptions.py`
- 修改：`backend/api/__init__.py`

**Step 1: 创建 exceptions.py**

```python
# backend/api/exceptions.py
"""统一 API 异常体系"""


class APIException(Exception):
    """API 统一异常基类"""
    
    def __init__(
        self,
        message: str,
        code: str = "UNKNOWN_ERROR",
        status_code: int = 400
    ):
        self.message = message
        self.code = code
        self.status_code = status_code
        super().__init__(message)


class NotFoundError(APIException):
    """资源不存在异常"""
    
    def __init__(self, resource: str, resource_id: str):
        super().__init__(
            message=f"{resource} 不存在: {resource_id}",
            code="NOT_FOUND",
            status_code=404
        )


class ValidationError(APIException):
    """验证错误异常"""
    
    def __init__(self, message: str):
        super().__init__(
            message=message,
            code="VALIDATION_ERROR",
            status_code=422
        )


class AuthenticationError(APIException):
    """认证错误异常"""
    
    def __init__(self, message: str = "未授权访问"):
        super().__init__(
            message=message,
            code="AUTHENTICATION_ERROR",
            status_code=401
        )


class ExecutionError(APIException):
    """执行错误异常"""
    
    def __init__(self, message: str, execution_id: str = None):
        detail = f" (execution_id: {execution_id})" if execution_id else ""
        super().__init__(
            message=f"执行错误: {message}{detail}",
            code="EXECUTION_ERROR",
            status_code=500
        )
```

**Step 2: 创建统一响应格式**

```python
# backend/api/response.py
"""统一 API 响应格式"""
from typing import Any, Optional


def success_response(data: Any = None) -> dict:
    """成功响应"""
    return {"success": True, "data": data}


def error_response(message: str, code: str = "ERROR") -> dict:
    """错误响应"""
    return {
        "success": False,
        "error": {
            "code": code,
            "message": message
        }
    }


def paginated_response(
    items: list,
    total: int,
    page: int = 1,
    page_size: int = 20
) -> dict:
    """分页响应"""
    return {
        "success": True,
        "data": {
            "items": items,
            "total": total,
            "page": page,
            "page_size": page_size,
            "total_pages": (total + page_size - 1) // page_size
        }
    }
```

**Step 3: 验证语法**

```bash
cd backend && python -c "from api.exceptions import APIException, NotFoundError; print('OK')"
```

**Step 4: Commit**

```bash
git add backend/api/exceptions.py backend/api/response.py
git commit -m "feat(api): 添加统一异常体系和响应格式"
```

---

## Task 5: 添加后端全局异常处理器

**文件：**
- 修改：`backend/main.py`

**Step 1: 在 main.py 中添加异常处理器**

首先读取当前 main.py 内容：

```bash
head -50 backend/main.py
```

在 main.py 中添加导入和异常处理器（在 app 创建后添加）：

```python
# 在文件顶部添加导入
import logging
from fastapi import Request
from fastapi.responses import JSONResponse
from fastapi.exceptions import RequestValidationError
from api.exceptions import APIException

logger = logging.getLogger(__name__)

# 在 app = FastAPI(...) 之后添加

@app.exception_handler(APIException)
async def api_exception_handler(request: Request, exc: APIException):
    """处理 APIException"""
    logger.warning(f"API异常: {exc.code} - {exc.message}")
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "success": False,
            "error": {
                "code": exc.code,
                "message": exc.message
            }
        }
    )


@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    """处理请求验证错误"""
    errors = []
    for error in exc.errors():
        errors.append({
            "field": ".".join(str(loc) for loc in error["loc"]),
            "message": error["msg"]
        })
    logger.warning(f"验证错误: {errors}")
    return JSONResponse(
        status_code=422,
        content={
            "success": False,
            "error": {
                "code": "VALIDATION_ERROR",
                "message": "请求参数验证失败",
                "details": errors
            }
        }
    )


@app.exception_handler(Exception)
async def generic_exception_handler(request: Request, exc: Exception):
    """处理未捕获的异常"""
    logger.exception(f"未处理的异常: {type(exc).__name__}: {exc}")
    return JSONResponse(
        status_code=500,
        content={
            "success": False,
            "error": {
                "code": "INTERNAL_ERROR",
                "message": "服务器内部错误"
            }
        }
    )
```

**Step 2: 验证后端启动**

```bash
cd backend && timeout 5 python main.py || true
```

预期：无语法错误，正常启动

**Step 3: Commit**

```bash
git add backend/main.py
git commit -m "feat(api): 添加全局异常处理器"
```

---

## Task 6: 优化 Button 组件交互效果

**文件：**
- 修改：`frontend/src/components/ui/Button.tsx`

**Step 1: 增强按钮交互效果**

修改 `variantClasses` 和基础样式，添加按下反馈：

```typescript
// frontend/src/components/ui/Button.tsx

// 修改 variantClasses
const variantClasses: Record<ButtonVariant, string> = {
  primary: 'bg-blue-500 text-white hover:bg-blue-600 active:bg-blue-700 active:scale-[0.98]',
  secondary: 'bg-neutral-100 text-neutral-900 hover:bg-neutral-200 active:bg-neutral-300 active:scale-[0.98] border border-neutral-200',
  danger: 'bg-red-500 text-white hover:bg-red-600 active:bg-red-700 active:scale-[0.98]',
  ghost: 'bg-transparent text-neutral-600 hover:bg-neutral-100 active:bg-neutral-200 active:scale-[0.98]',
}
```

修改 baseClasses，添加 focus-visible：

```typescript
// 修改 baseClasses
const baseClasses =
  'inline-flex items-center justify-center font-medium rounded-md transition-all duration-200 ease-out focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-400'
```

修改 stateClasses，增强 hover 效果：

```typescript
// 修改 stateClasses
const stateClasses = isDisabled
  ? 'opacity-50 cursor-not-allowed'
  : 'cursor-pointer hover:shadow-sm'
```

**Step 2: 验证编译**

```bash
cd frontend && npm run build
```

**Step 3: Commit**

```bash
git add frontend/src/components/ui/Button.tsx
git commit -m "feat(ui): 增强 Button 组件交互效果"
```

---

## Task 7: 优化 Input 组件交互效果

**文件：**
- 修改：`frontend/src/components/ui/Input.tsx`

**Step 1: 添加 hover 边框色变化**

修改输入框样式，在 className 中添加 hover 状态：

找到 `// 边框样式` 注释部分，修改为：

```typescript
// 边框样式
showError 
  ? 'border-red-500 hover:border-red-500 focus:border-red-500 focus:ring-2 focus:ring-red-500/20'
  : 'border-neutral-200 hover:border-neutral-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20',
```

**Step 2: 验证编译**

```bash
cd frontend && npm run build
```

**Step 3: Commit**

```bash
git add frontend/src/components/ui/Input.tsx
git commit -m "feat(ui): 增强 Input 组件 hover 效果"
```

---

## Task 8: 优化 Textarea 组件交互效果

**文件：**
- 修改：`frontend/src/components/ui/Textarea.tsx`

**Step 1: 读取当前 Textarea 组件**

```bash
cat frontend/src/components/ui/Textarea.tsx
```

**Step 2: 添加与 Input 一致的交互效果**

确保 Textarea 有以下样式：
- `hover:border-neutral-300`
- `focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20`
- `transition-all duration-150 ease-out`

如果需要修改，参考 Input 组件的样式进行更新。

**Step 3: 验证编译**

```bash
cd frontend && npm run build
```

**Step 4: Commit**

```bash
git add frontend/src/components/ui/Textarea.tsx
git commit -m "feat(ui): 增强 Textarea 组件交互效果"
```

---

## Task 9: 优化 Select 组件交互效果

**文件：**
- 修改：`frontend/src/components/ui/Select.tsx`

**Step 1: 读取当前 Select 组件**

```bash
cat frontend/src/components/ui/Select.tsx
```

**Step 2: 添加完整交互状态**

确保 Select 组件有以下样式：
- `hover:border-neutral-300`
- `focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20`
- `transition-all duration-150 ease-out`
- 选项 hover 效果

如果需要修改，添加这些样式。

**Step 3: 验证编译**

```bash
cd frontend && npm run build
```

**Step 4: Commit**

```bash
git add frontend/src/components/ui/Select.tsx
git commit -m "feat(ui): 增强 Select 组件交互效果"
```

---

## Task 10: 优化 Modal 组件动画

**文件：**
- 修改：`frontend/src/components/ui/Modal.tsx`
- 修改：`frontend/src/index.css` 或 tailwind 配置（如需自定义动画）

**Step 1: 检查当前动画**

Modal 组件已有 `animate-fade-in` 和 `animate-scale-in`，检查这些动画是否在 Tailwind 配置中定义。

**Step 2: 确保 Tailwind 配置有动画定义**

检查 `frontend/tailwind.config.js` 或 CSS 文件：

```bash
grep -r "animate-fade-in\|animate-scale-in" frontend/src --include="*.css" --include="*.js"
```

如果未定义，在 `frontend/src/index.css` 中添加：

```css
@keyframes fade-in {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes scale-in {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes scale-out {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.95);
  }
}

.animate-fade-in {
  animation: fade-in 0.2s ease-out;
}

.animate-scale-in {
  animation: scale-in 0.2s ease-out;
}

.animate-scale-out {
  animation: scale-out 0.15s ease-in;
}
```

**Step 3: 验证动画效果**

```bash
cd frontend && npm run build
```

**Step 4: Commit**

```bash
git add frontend/src/index.css
git commit -m "feat(ui): 添加 Modal 动画定义"
```

---

## Task 11: 运行完整测试和验证

**Step 1: 运行前端测试**

```bash
cd frontend && npm run test
```

预期：所有测试通过

**Step 2: 运行前端 lint**

```bash
cd frontend && npm run lint
```

预期：无错误

**Step 3: 运行前端构建**

```bash
cd frontend && npm run build
```

预期：构建成功

**Step 4: 验证后端**

```bash
cd backend && python -c "from main import app; print('OK')"
```

**Step 5: 最终 Commit（如有遗漏）**

```bash
git status
# 如果有未提交的更改，提交它们
```

---

## 完成检查清单

- [ ] stores/base.ts 创建完成
- [ ] useErrorHandler hook 创建并使用
- [ ] App.tsx 错误处理统一
- [ ] 后端 exceptions.py 创建
- [ ] 后端 response.py 创建
- [ ] 后端全局异常处理器添加
- [ ] Button 组件交互优化
- [ ] Input 组件 hover 效果
- [ ] Textarea 组件交互优化
- [ ] Select 组件交互优化
- [ ] Modal 动画定义
- [ ] 所有测试通过

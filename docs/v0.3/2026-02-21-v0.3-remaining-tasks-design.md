# V0.3 剩余任务实施设计

## 概述

本文档规划V0.3迭代剩余任务的实施方案，包括功能补全（C）和样式优化（D）。

## 实施策略

采用**方案A：按功能模块推进**，共4个阶段：

| 阶段 | 任务 | 时长 |
|------|------|------|
| 阶段1 | 补全基础节点（C4） | 2-3天 |
| 阶段2 | AI智能元素定位（C1） | 3-4天 |
| 阶段3 | Browser Use集成（C2） | 2-3天 |
| 阶段4 | 样式优化（D1-D7） | 5-7天 |

**总时长：** 约2周

---

## 阶段1：补全基础节点（C4）

### 目标

实现缺失的5个节点，增强基础操作能力。

### 涉及文件

- `backend/engine/actions/browser.py` - 添加 switch_tab、close_tab、select_option、scroll
- `backend/engine/actions/data.py` - 添加 custom_script

### 实现要点

#### switch_tab
支持按 index 或 title_match 切换标签页：
```python
@register_action(
    name="switch_tab",
    label="切换标签页",
    category="browser",
    parameters={
        "index": {"type": "integer", "description": "标签页索引（从0开始）"},
        "title_match": {"type": "string", "description": "按标题匹配（模糊匹配）"},
    }
)
async def switch_tab_action(context, config):
    pages = context.browser.contexts[0].pages
    if "index" in config:
        context.page = pages[config["index"]]
    elif "title_match" in config:
        for page in pages:
            if config["title_match"] in page.title():
                context.page = page
                break
```

#### close_tab
关闭当前页面，切换到上一个页面。

#### select_option
使用 `page.locator(selector).select_option(value)`。

#### scroll
使用 `page.evaluate("window.scrollBy(0, {pixels})")`。

#### custom_script
使用 `exec()` 在沙箱环境执行用户脚本，通过 context.variables 共享变量。

---

## 阶段2：AI智能元素定位（C1）

### 目标

构建真正的LLM驱动的智能元素定位系统。

### 涉及文件

- `backend/engine/ai_locator.py`（新建）- AI定位核心逻辑
- `backend/engine/actions/browser.py` - click、input_text 的 ai_target 改为调用 AI 定位
- `backend/engine/actions/utils.py` - 公共 locate_element() 函数调用 ai_locator

### 核心流程

1. **获取页面DOM快照**：提取可交互元素，简化属性，限制数量
2. **构建LLM Prompt**：包含URL、用户描述、元素列表
3. **LLM返回结构化结果**：best_match_index、selector、confidence、reasoning、alternatives
4. **执行和验证**：使用selector定位，验证可见性，失败尝试alternatives
5. **错误处理和记录**：详细记录失败原因到执行记录

### 关键技术点

#### DOM提取
JavaScript注入页面，提取button、a、input等交互元素：
```python
async def extract_interactive_elements(page):
    return await page.evaluate("""
        () => {
            const interactiveSelectors = [
                'button', 'a', 'input', 'select', 'textarea',
                '[onclick]', '[role="button"]', '[role="link"]',
                '[tabindex]:not([tabindex="-1"])'
            ];
            const elements = document.querySelectorAll(interactiveSelectors.join(','));

            const visible = Array.from(elements)
                .filter(el => {
                    const rect = el.getBoundingClientRect();
                    return rect.width > 0 && rect.height > 0;
                })
                .slice(0, 100);

            return visible.map((el, idx) => ({
                index: idx,
                tag: el.tagName.toLowerCase(),
                id: el.id || null,
                className: el.className || null,
                text: el.innerText?.trim().slice(0, 100) || null,
                ariaLabel: el.getAttribute('aria-label'),
                placeholder: el.placeholder || null,
            }));
        }
    """)
```

#### Prompt设计
结构化返回JSON，置信度评分，可解释推理：
```
System:
你是网页元素定位专家。根据用户描述和页面DOM，找出最匹配的元素选择器。

规则：
1. 返回JSON格式
2. 必须包含best_match_index、selector、confidence、reasoning
3. confidence范围0-1，低于0.5表示不确定
4. 如果没有合适匹配，设置best_match_index为-1并说明原因

User:
页面URL: {url}
用户想要: {ai_target}
可交互元素：[...]
```

#### 执行记录
失败时记录分析过程：
```
AI定位失败：「登录按钮」
- 分析了45个可交互元素
- 最接近的候选：#submit-btn（置信度0.95）
- 失败原因：元素被遮挡
- 建议：尝试滚动页面或使用更具体的描述
```

#### 性能优化
- DOM缓存：同一页面多次定位时复用DOM快照
- 并发限制：全局限制LLM并发调用数
- 超时控制：单次定位超时10秒

---

## 阶段3：Browser Use集成（C2）

### 目标

集成browser-use库，实现ai_action节点。

### 涉及文件

- `backend/engine/actions/ai.py`（新建）- ai_action节点实现
- `frontend/src/components/FlowEditor/nodes/AINode.tsx`（新建）- AI节点前端组件

### 集成方式

```python
from browser_use import Agent

@register_action(
    name="ai_action",
    label="AI自动化",
    description="使用AI理解自然语言指令并执行浏览器操作",
    category="ai",
    parameters={
        "prompt": {"type": "string", "description": "自然语言指令"},
        "max_steps": {"type": "integer", "description": "最大执行步数（默认10）"},
    }
)
async def ai_action_action(context, config):
    prompt = config.get("prompt")
    max_steps = config.get("max_steps", 10)

    agent = Agent(
        task=prompt,
        browser=context.browser,
        page=context.page,
    )

    # 设置步数限制
    await agent.run(max_steps=max_steps)

    return {"result": "AI自动化执行完成"}
```

### 配置参数

```json
{
  "prompt": "搜索'iPhone'并点击第一个结果",
  "max_steps": 10
}
```

### 关键技术点

- browser-use Agent配置：传入context的browser和page
- 任务描述：用户自然语言指令
- 步数限制：max_steps控制最大执行步数
- 结果返回：browser-use的执行结果
- 错误处理：捕获browser-use异常，记录到执行记录

### 与现有架构集成

- 复用现有的browser连接和上下文
- 执行记录通过ExecutionRecorder统一管理
- 截图和日志通过context.log记录

---

## 阶段4：样式优化（D1-D7）

### 目标

完整UI美化，提升用户体验。

### D1. 整体设计语言

- 采用浅色主题 + 蓝色主色调
- 圆润的卡片式布局，参考n8n/Retool风格
- 统一间距、圆角、阴影等设计token

### D2. 节点样式升级

**涉及文件：**
- `frontend/src/components/FlowEditor/nodes/BaseNode.tsx`
- `frontend/src/components/FlowEditor/nodes/StartNode.tsx`
- `frontend/src/components/FlowEditor/nodes/EndNode.tsx`

**改进点：**
1. 节点卡片：添加左侧分类色条、图标更大更清晰、增加节点描述行
2. 连接点（Handle）：增大可点击区域，hover时高亮
3. 状态动画：running时节点边框流光效果，completed时短暂绿色闪烁
4. 选中态：明显的蓝色外框 + 轻微放大

### D3. 顶部导航优化

**改进点：**
- 添加Logo/品牌标识
- 工作流名称可点击编辑
- 执行按钮增加图标，区分状态（就绪/执行中/完成）
- 模式选择改为toggle按钮组而非select

### D4. 侧边栏优化

**左侧工作流列表：**
- 添加搜索/过滤功能
- 列表项增加最后修改时间
- 当前选中项高亮更明显
- 空列表增加引导提示

**左侧工具栏（Toolbar）：**
- 节点分组折叠/展开
- 节点拖拽时显示ghost预览
- AI编排输入框样式美化

### D5. 执行面板优化

**改进点：**
- 截图区域增加缩放手势
- 节点执行记录增加时间线视图
- 日志区域支持按级别过滤
- 用户输入对话框改为modal样式

### D6. 空状态和加载状态

**涉及文件：**
- `frontend/src/components/common/EmptyState.tsx`（新建）
- `frontend/src/components/common/LoadingSpinner.tsx`（新建）

**场景覆盖：**

| 场景 | 当前 | 改进 |
|------|------|------|
| 未选择工作流 | "选择或创建一个工作流开始" 纯文字 | 插图 + 引导按钮 |
| 工作流列表为空 | 无提示 | "还没有工作流，创建第一个吧" + 按钮 |
| AI编排生成中 | "生成中..." 文字 | 带动画的loading指示器 |
| 执行面板无数据 | 空白 | "点击执行按钮开始" 提示 |
| 节点属性未选中节点 | "选择一个节点查看属性" | 带图标的提示 |

### D7. 响应式布局（简化版）

- 侧边栏可折叠/展开
- 小屏时自动隐藏MiniMap

---

## 实施顺序总结

```
阶段1（C4基础节点）→ 阶段2（C1 AI定位）→ 阶段3（C2 Browser Use）→ 阶段4（D1-D7样式）
    ↓                    ↓                    ↓                    ↓
 2-3天               3-4天               2-3天                5-7天
```

## 注意事项

1. **依赖关系**：C2依赖C1（复用AI定位能力）
2. **测试验证**：每个阶段完成后运行现有测试
3. **文档更新**：及时更新README和API文档
4. **向后兼容**：确保不破坏现有工作流和API
